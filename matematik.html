<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Keluarga App: Latihan Matematik Ceria!</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka+One&family=Nunito:wght@700&display=swap');

        :root {
            --bg-color-start: #87CEEB; /* Sky Blue */
            --bg-color-end: #E0F7FA;   /* Light Cyan */
            --primary-color: #FFD54F; /* Sunny Yellow */
            --primary-dark: #FFB300;
            --correct-color: #81C784; /* Friendly Green */
            --correct-dark: #388E3C;
            --wrong-color: #E57373;   /* Soft Red */
            --wrong-dark: #C62828;
            --text-color: #37474F; /* Dark Slate Blue */
            --card-bg: #ffffff;
            --line-color: #546E7A;
            --numpad-bg: #CFD8DC;
            --numpad-bg-dark: #90A4AE;
        }

        body {
            font-family: 'Nunito', sans-serif;
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Align to top */
            min-height: 100vh;
            margin: 0;
            background: linear-gradient(180deg, var(--bg-color-start), var(--bg-color-end));
            background-image: 
                linear-gradient(180deg, var(--bg-color-start), var(--bg-color-end)),
                url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100' viewBox='0 0 100 100'%3E%3Cpath d='M 80 60 A 20 20 0 1 0 50 60 A 20 20 0 1 0 80 60 Z' fill='%23FFFFFF' fill-opacity='0.7'/%3E%3C/svg%3E"),
                url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='80' height='80' viewBox='0 0 80 80'%3E%3Cpath d='M 60 40 A 15 15 0 1 0 35 40 A 15 15 0 1 0 60 40 Z' fill='%23FFFFFF' fill-opacity='0.6'/%3E%3C/svg%3E");
            background-repeat: no-repeat, repeat-x, repeat-x;
            background-position: center, 20px 80px, 80px 250px;
            background-size: cover, 150px, 120px;
            padding: 2rem 15px 15px 15px; /* Add top padding */
            box-sizing: border-box;
        }

        #app-container {
            width: 95%;
            max-width: 420px;
            background-color: var(--card-bg);
            padding: 25px;
            border-radius: 30px;
            box-shadow: 0 12px 35px rgba(0, 0, 0, 0.1), 0 4px 10px rgba(0,0,0,0.08);
            text-align: center;
            border: 4px solid white;
        }

        h1 {
            font-family: 'Fredoka One', cursive;
            color: var(--primary-color);
            margin-top: 0;
            margin-bottom: 20px;
            font-size: clamp(2.5em, 10vw, 3.5em); /* Responsive font size */
            text-shadow: 3px 3px 0px var(--primary-dark), 6px 6px 0px rgba(0,0,0,0.1);
            -webkit-text-stroke: 2px #a67c00;
        }
        
        #selection-screen h2 {
            font-family: 'Fredoka One', cursive;
            color: var(--text-color);
            font-size: 1.8em;
            margin-bottom: 10px;
        }
        .selection-group { margin-bottom: 20px; }

        .selection-group button {
            padding: 12px 18px;
            font-size: 1em;
            margin: 5px;
            cursor: pointer;
            border: 3px solid var(--primary-dark);
            background-color: white;
            color: var(--primary-dark);
            border-radius: 20px;
            font-weight: 700;
            transition: all 0.3s ease;
        }
        .selection-group button.selected, .selection-group button:hover {
            background-color: var(--primary-color);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        #operator-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 15px;
        }
        .operator-btn {
            padding: 20px;
            font-family: 'Fredoka One', cursive;
            font-size: 3em;
            border-radius: 20px;
            color: white;
            transition: all 0.1s ease-in-out;
            border: none;
            cursor: pointer;
        }
        .operator-btn:active {
            transform: translateY(4px);
            box-shadow: 0 2px 0 var(--shadow-color);
        }
        #op-add { background-color: #4FC3F7; box-shadow: 0 6px 0 #039BE5; --shadow-color: #039BE5;}
        #op-subtract { background-color: #FF8A65; box-shadow: 0 6px 0 #F4511E; --shadow-color: #F4511E;}
        #op-multiply { background-color: #BA68C8; box-shadow: 0 6px 0 #8E24AA; --shadow-color: #8E24AA;}
        #op-divide { background-color: #AED581; box-shadow: 0 6px 0 #689F38; --shadow-color: #689F38;}

        #game-screen, #final-score-screen { display: none; }
        #game-screen { position: relative; }
        
        #score-display {
            font-family: 'Fredoka One', cursive;
            font-size: 1.3em;
            color: #78909C;
            margin-bottom: 15px;
        }

        #lazim-table { width: 100%; margin: 5px 0 20px; font-family: 'Fredoka One', cursive; font-size: clamp(2.5em, 12vw, 3.5em); border-collapse: collapse; }
        #lazim-table td { text-align: center; width: 1.5em; height: 1.5em; padding: 3px; }
        .digit-box { 
            background-color: #E3F2FD; 
            color: #0D47A1; 
            border-radius: 15px; 
            width: 1.5em; height: 1.5em; 
            display: flex; justify-content: center; align-items: center; 
            margin: auto;
            border: 2px solid #90CAF9;
            box-shadow: inset 0 3px 5px rgba(0,0,0,0.1);
        }
        .operator-cell { font-size: 1.2em; }
        .number-row-2 { border-bottom: 8px solid var(--line-color); }
        
        #answer-display { 
            width: 100%; height: 1.5em; font-family: 'Fredoka One', cursive; font-size: 1em; text-align: right; 
            padding: 0 10px; box-sizing: border-box; letter-spacing: 0.3em;
            border-bottom: 5px dashed #B0BEC5; 
            color: var(--text-color); min-height: 1.5em;
        }

        #feedback-message { font-size: 1.6em; font-weight: 700; min-height: 45px; margin-top: 15px; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; gap: 10px;}
        
        .action-button { 
            font-weight: 700; 
            cursor: pointer; 
            color: white; 
        }
        
        #back-button { position: absolute; top: -15px; right: -15px; padding: 10px 18px; font-size: 1em; background-color: #9E9E9E; box-shadow: 0 5px 0 #616161; --shadow-color: #616161; border:none; border-radius: 20px; transition: all 0.1s ease;}
        #back-button:active {transform: translateY(4px); box-shadow: 0 2px 0 #616161;}

        #numpad {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-top: 20px;
        }
        .numpad-btn {
            font-family: 'Fredoka One', cursive;
            font-size: 1.8em;
            padding: 15px;
            border: none;
            border-radius: 18px;
            background-color: #ECEFF1;
            box-shadow: 0 5px 0 var(--numpad-bg-dark);
            color: var(--text-color);
            transition: all 0.1s ease;
            -webkit-tap-highlight-color: transparent; /* Remove tap highlight on mobile */
        }
        .numpad-btn:active {
            transform: translateY(3px);
            box-shadow: 0 2px 0 var(--numpad-bg-dark);
        }

        #check-button { background-color: #42A5F5; box-shadow: 0 5px 0 #1976D2; --shadow-color: #1976D2;}
        #next-button { background-color: var(--primary-color); box-shadow: 0 5px 0 var(--primary-dark); --shadow-color: var(--primary-dark); }


        .correct { color: var(--correct-color); transform: scale(1.1); }
        .wrong { color: var(--wrong-color); animation: shake 0.5s; }
        
        #feedback-message.correct::before { content: '‚≠ê'; animation: pop 0.5s ease; }
        #feedback-message.wrong::before { content: 'ü§î'; }

        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-10px); } 75% { transform: translateX(10px); } }
        @keyframes pop { 0% { transform: scale(0.5); } 100% { transform: scale(1); } }

        /* Final Score Screen Styling */
        #final-score-screen { position: relative; }
        #final-score-screen h2 { font-size: 2.5em; color: var(--text-color); }
        #final-score { animation: score-pop-in 0.8s ease-out; }

        .star {
            position: absolute;
            width: 20px;
            height: 20px;
            background-color: var(--primary-color);
            clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%);
            animation: twinkle 2s infinite ease-in-out;
        }
        .star.s1 { top: 10%; left: 15%; animation-delay: 0s; }
        .star.s2 { top: 20%; right: 10%; width: 30px; height: 30px; animation-delay: 0.5s; }
        .star.s3 { bottom: 15%; left: 25%; width: 15px; height: 15px; animation-delay: 1s; }
        .star.s4 { bottom: 25%; right: 20%; animation-delay: 1.5s; }
        
        @keyframes score-pop-in {
            0% { transform: scale(0.5); opacity: 0; }
            80% { transform: scale(1.1); opacity: 1; }
            100% { transform: scale(1); }
        }
        @keyframes twinkle {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(0.7); opacity: 0.5; }
        }

    </style>
</head>
<body>
    <div id="app-container">
        <h1>Latihan Matematik!</h1>
        <div id="selection-screen">
            <div class="selection-group">
                <h2>Pilih Tahap</h2>
                <button data-selection="difficulty" data-value="very_easy" class="selected">Sangat Mudah</button>
                <button data-selection="difficulty" data-value="easy">Mudah</button>
                <button data-selection="difficulty" data-value="normal">Biasa</button>
            </div>
             <div class="selection-group">
                <h2>Pilih Latihan</h2>
                <div id="operator-buttons">
                    <button id="op-add" class="operator-btn" data-op="+">+</button>
                    <button id="op-subtract" class="operator-btn" data-op="-">-</button>
                    <button id="op-multiply" class="operator-btn" data-op="*">√ó</button>
                    <button id="op-divide" class="operator-btn" data-op="/">√∑</button>
                </div>
            </div>
        </div>
        <div id="game-screen">
            <button id="back-button" class="action-button">Menu</button>
            <div id="score-display"></div>
            <table id="lazim-table"></table>
            <div id="feedback-message"></div>
            <div id="numpad"></div>
        </div>
        <div id="final-score-screen">
            <div class="star s1"></div>
            <div class="star s2"></div>
            <div class="star s3"></div>
            <div class="star s4"></div>
            <h2>Hebat!</h2>
            <p style="font-size: 1.5em; margin: 20px 0;">Skor Anda:</p>
            <p id="final-score" style="font-family: 'Fredoka One', cursive; font-size: 5em; color: var(--correct-color); margin: 10px 0;"></p>
            <button id="play-again-menu" class="action-button" style="background-color: var(--primary-color); box-shadow: 0 6px 0 var(--primary-dark); --shadow-color: var(--primary-dark);">Main Lagi</button>
        </div>
    </div>

    <script>
        class MathGame {
            constructor() {
                this.selectionScreen = document.getElementById('selection-screen');
                this.gameScreen = document.getElementById('game-screen');
                this.scoreDisplay = document.getElementById('score-display');
                this.lazimTable = document.getElementById('lazim-table');
                this.feedbackMessage = document.getElementById('feedback-message');
                this.backButton = document.getElementById('back-button');
                this.finalScoreScreen = document.getElementById('final-score-screen');
                this.finalScoreEl = document.getElementById('final-score');
                this.playAgainMenuButton = document.getElementById('play-again-menu');
                this.numpad = document.getElementById('numpad');

                this.checkButton = null;
                this.nextButton = null;

                this.correctAnswer = 0;
                this.answerDisplay = null;
                this.currentDifficulty = 'very_easy';
                this.difficultySettings = { 'very_easy': { add: 10, subtract: 10, multiply: 5, divide: { d: 5, q: 5 } }, 'easy': { add: 50, subtract: 50, multiply: 10, divide: { d: 10, q: 10 } }, 'normal': { add: 100, subtract: 100, multiply: 12, divide: { d: 12, q: 12 } } };
                this.currentOperation = '+';
                this.score = 0;
                this.questionCount = 0;
                this.totalQuestions = 10;
                
                this.buildNumpad();
                this.setupEventListeners();
            }
            setupEventListeners() {
                document.querySelectorAll('button[data-selection="difficulty"]').forEach(b => { b.addEventListener('click', (e) => { this.currentDifficulty = e.target.dataset.value; document.querySelectorAll('button[data-selection="difficulty"]').forEach(btn => btn.classList.remove('selected')); e.target.classList.add('selected'); }); });
                document.querySelectorAll('.operator-btn').forEach(b => { b.addEventListener('click', () => this.startGame(b.dataset.op)); });
                this.backButton.addEventListener('click', () => this.showMenu());
                this.playAgainMenuButton.addEventListener('click', () => this.showMenu());
            }
            buildNumpad() {
                this.numpad.innerHTML = '';
                const buttons = [ '1', '2', '3', '4', '5', '6', '7', '8', '9', 'Padam', '0' ];
                
                buttons.forEach(val => {
                    const btn = document.createElement('button');
                    btn.classList.add('numpad-btn');
                    btn.textContent = val;
                    if (val === 'Padam') {
                        btn.addEventListener('click', () => this.deleteNumber());
                    } else {
                        btn.addEventListener('click', () => this.appendNumber(val));
                    }
                    this.numpad.appendChild(btn);
                });
                
                // Create a container for the action buttons to manage toggling
                const actionCell = document.createElement('div');
                actionCell.style.position = 'relative'; // To stack buttons
                
                // Create Semak button
                const checkBtn = document.createElement('button');
                checkBtn.id = 'check-button';
                checkBtn.classList.add('numpad-btn', 'action-button');
                checkBtn.textContent = 'Semak';
                checkBtn.addEventListener('click', () => this.checkAnswer());
                this.checkButton = checkBtn;
                actionCell.appendChild(checkBtn);
                
                // Create Seterusnya button
                const nextBtn = document.createElement('button');
                nextBtn.id = 'next-button';
                nextBtn.classList.add('numpad-btn', 'action-button');
                nextBtn.textContent = 'Next';
                nextBtn.style.display = 'none'; // Initially hidden
                nextBtn.addEventListener('click', () => this.nextQuestion());
                this.nextButton = nextBtn;
                actionCell.appendChild(nextBtn);

                this.numpad.appendChild(actionCell);
            }
            appendNumber(num) { if (this.answerDisplay && this.checkButton.style.display !== 'none') this.answerDisplay.textContent += num; }
            deleteNumber() { if (this.answerDisplay) this.answerDisplay.textContent = this.answerDisplay.textContent.slice(0, -1); }
            showMenu() { this.gameScreen.style.display = 'none'; this.finalScoreScreen.style.display = 'none'; this.selectionScreen.style.display = 'block'; }
            startGame(operation) { this.currentOperation = operation; this.score = 0; this.questionCount = 0; this.selectionScreen.style.display = 'none'; this.finalScoreScreen.style.display = 'none'; this.gameScreen.style.display = 'block'; this.nextQuestion(); }
            generateQuestion() {
                let num1, num2;
                const settings = this.difficultySettings[this.currentDifficulty];
                const opSymbol = this.currentOperation === '*' ? '√ó' : (this.currentOperation === '/' ? '√∑' : this.currentOperation);
                switch(this.currentOperation) {
                    case '+': num1 = Math.floor(Math.random() * (settings.add + 1)); num2 = Math.floor(Math.random() * (settings.add + 1)); this.correctAnswer = num1 + num2; break;
                    case '-': num1 = Math.floor(Math.random() * (settings.subtract + 1)); num2 = Math.floor(Math.random() * (num1 + 1)); this.correctAnswer = num1 - num2; break;
                    case '*': num1 = Math.floor(Math.random() * (settings.multiply + 1)); num2 = Math.floor(Math.random() * (settings.multiply + 1)); this.correctAnswer = num1 * num2; break;
                    case '/': const d = Math.floor(Math.random() * (settings.divide.d - 1)) + 2; const q = Math.floor(Math.random() * settings.divide.q) + 1; num1 = d * q; num2 = d; this.correctAnswer = q; break;
                }
                this.buildLazimTable(num1, num2, opSymbol);
            }
            buildLazimTable(num1, num2, operator) {
                this.lazimTable.innerHTML = '';
                const num1Str = String(num1).padStart(3, ' '); const num2Str = String(num2).padStart(3, ' ');
                const row1 = this.lazimTable.insertRow(); row1.insertCell();
                for (const char of num1Str) { if (char !== ' ') { row1.insertCell().innerHTML = `<div class="digit-box">${char}</div>`; } else { row1.insertCell(); } }
                const row2 = this.lazimTable.insertRow(); row2.classList.add('number-row-2');
                row2.insertCell().textContent = operator; row2.cells[0].classList.add('operator-cell');
                for (const char of num2Str) { if (char !== ' ') { row2.insertCell().innerHTML = `<div class="digit-box">${char}</div>`; } else { row2.insertCell(); } }
                const answerRow = this.lazimTable.insertRow(); answerRow.classList.add('answer-row'); answerRow.insertCell();
                const answerCell = answerRow.insertCell(); answerCell.colSpan = 3;
                this.answerDisplay = document.createElement('div'); this.answerDisplay.id = 'answer-display';
                answerCell.appendChild(this.answerDisplay);
            }
            checkAnswer() {
                if (!this.answerDisplay) return;
                const userAnswer = parseInt(this.answerDisplay.textContent, 10);
                this.feedbackMessage.classList.remove('correct', 'wrong');
                
                // Jika tiada nombor dimasukkan, paparkan mesej dan hentikan fungsi.
                if (isNaN(userAnswer)) {
                    this.feedbackMessage.textContent = 'Sila masukkan nombor!';
                    this.feedbackMessage.classList.add('wrong');
                    return; // Hentikan fungsi di sini, jangan tambah `questionCount`
                }
                
                // Hanya tambah `questionCount` jika jawapan diberi.
                this.questionCount++;

                if (userAnswer === this.correctAnswer) {
                    this.feedbackMessage.textContent = 'Bijak!';
                    this.feedbackMessage.classList.add('correct');
                    this.score++;
                } else {
                    this.feedbackMessage.textContent = `Jawapannya ${this.correctAnswer}`;
                    this.feedbackMessage.classList.add('wrong');
                }

                this.updateScore();
                this.toggleButtons(true);
            }
            nextQuestion() { if (this.questionCount >= this.totalQuestions) { this.showFinalScore(); return; } this.generateQuestion(); this.feedbackMessage.textContent = ''; this.feedbackMessage.classList.remove('correct', 'wrong'); this.toggleButtons(false); this.updateScore(); }
            showFinalScore() { this.gameScreen.style.display = 'none'; this.finalScoreScreen.style.display = 'block'; this.finalScoreEl.textContent = `${this.score} / ${this.totalQuestions}`; }
            updateScore() { this.scoreDisplay.textContent = `Skor: ${this.score} | Soalan: ${this.questionCount + 1} / ${this.totalQuestions}`; }
            toggleButtons(isAnswered) { 
                if (!this.checkButton || !this.nextButton) return;
                if (isAnswered) { 
                    this.checkButton.style.display = 'none'; 
                    this.nextButton.style.display = 'inline-block'; 
                    this.nextButton.focus(); 
                } else { 
                    this.checkButton.style.display = 'inline-block'; 
                    this.nextButton.style.display = 'none'; 
                } 
            }
        }

        document.addEventListener('DOMContentLoaded', () => new MathGame());
    </script>
</body>
</html>

