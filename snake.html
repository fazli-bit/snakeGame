<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Permainan Ular Klasik</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #1a1a1a;
            --primary-color: #00ff00;
            --accent-color: #ff00ff;
            --text-color: #f0f0f0;
            --grid-size: 20px;
        }

        body {
            background-color: #1a1a1a;
            background-image:
                linear-gradient(rgba(255, 255, 255, 0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.05) 1px, transparent 1px);
            background-size: 40px 40px;
            color: #f0f0f0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            font-family: 'Press Start 2P', cursive;
            overflow: hidden;
            padding: 10px;
            box-sizing: border-box;
        }

        /* Main game container */
        .game-container {
            text-align: center;
            border: 4px solid #555;
            border-radius: 15px;
            padding: 20px;
            background-color: #2b2b2b;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            position: relative;
            width: 100%;
            max-width: 500px;
        }

        h1 {
            font-size: 2rem;
            color: #00ff00;
            text-shadow: 2px 2px #000;
            margin-top: 0;
            margin-bottom: 20px;
        }
        
        #game-version {
            font-size: 0.7rem;
            color: #888;
            margin-top: -15px;
            margin-bottom: 15px;
        }

        /* Score & Stage display */
        #game-info-container {
            font-size: 1.1rem;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-around;
            width: 100%;
        }

        .info-box span {
            color: #ffff00;
        }
        
        #bonus-stage-title {
            color: #ff00ff;
            font-size: 1.5rem;
            text-shadow: 2px 2px #000;
            margin-bottom: 15px;
        }

        /* The game board itself */
        #game-board {
            background-color: #0c0c0c;
            width: 400px;
            height: 400px;
            border: 2px solid #00ff00;
            position: relative;
            border-radius: 5px;
            margin: 0 auto;
            overflow: hidden; /* Keep flash effect contained */
            background-image:
                linear-gradient(rgba(0, 255, 0, 0.1) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 255, 0, 0.1) 1px, transparent 1px);
            background-size: 20px 20px;
        }
        
        /* D-pad Controls for Mobile */
        #dpad-controls {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(3, 1fr);
            width: 180px;  /* Dibesarkan daripada 150px */
            height: 180px; /* Dibesarkan daripada 150px */
            margin: 25px auto 0; /* Menambah jarak dari atas */
            gap: 5px; /* Menambah ruang antara butang */
        }

        .dpad-button {
            background-color: rgba(255, 255, 255, 0.1);
            border: 2px solid #555;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            user-select: none; /* Prevent text selection */
        }

        .dpad-button:active {
            background-color: rgba(255, 255, 255, 0.3);
        }
        
        .dpad-button svg {
            width: 50%;
            height: 50%;
            fill: #00ff00;
        }
        
        #dpad-up    { grid-column: 2; grid-row: 1; border-top-left-radius: 10px; border-top-right-radius: 10px; }
        #dpad-left  { grid-column: 1; grid-row: 2; border-top-left-radius: 10px; border-bottom-left-radius: 10px; }
        #dpad-right { grid-column: 3; grid-row: 2; border-top-right-radius: 10px; border-bottom-right-radius: 10px; }
        #dpad-down  { grid-column: 2; grid-row: 3; border-bottom-left-radius: 10px; border-bottom-right-radius: 10px; }
        #dpad-center{ grid-column: 2; grid-row: 2; background: none; border: none; } /* Jadikan pusat lutsinar */

        /* Hide D-pad on larger screens */
        @media (min-width: 768px) {
            #dpad-controls {
                display: none;
            }
        }
        
        /* Game Objects */
        .game-object { position: absolute; box-sizing: border-box; display: flex; align-items: center; justify-content: center; font-size: 1.1em; }
        .snake-head { background-color: #33ff33; border-radius: 3px; z-index: 3; }
        .snake-body { background-color: lime; border: 1px solid #333; z-index: 2;}
        .snake-tail { background-color: #00dd00; z-index: 2;}
        .cobra-head { background-color: #ffd700; border-radius: 4px; z-index: 3; }
        .cobra-body { background-color: #f0e68c; border: 1px solid #a0522d; z-index: 2;}
        .cobra-tail { background-color: #daa520; z-index: 2;}
        .food { z-index: 1;}
        .food.portal { animation: spin 2s linear infinite; }
        .obstacle { background-color: #808080; box-shadow: inset 0 0 5px #333; z-index: 1;}
        .maze-wall { background-color: #3030ff; box-shadow: inset 0 0 10px #00008b; border-radius: 2px; z-index: 1;}
        .maze-exit { animation: spin 2s linear infinite; z-index: 1;}
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* --- General UI --- */
        .instructions-container { margin-top: 20px; }
        p.instructions { margin: 0; font-size: 0.8rem; color: #aaa; }
        .main-menu { display: flex; flex-direction: column; gap: 15px; align-items: center; }
        .menu-section { padding: 10px 20px; min-width: 300px; }
        .menu-section h2 { margin-top: 0; margin-bottom: 15px; color: #ffff00; font-size: 1.2rem; }
        .speed-control { display: flex; justify-content: center; align-items: center; margin-bottom: 15px; }
        #speed-display { font-size: 2.5rem; color: #00ff00; margin: 0 25px; width: 50px; text-align: center; }
        .speed-adjust-button {
            background: transparent; border: 2px solid #00ff00; color: #00ff00; font-size: 1.5rem;
            width: 40px; height: 40px; border-radius: 50%; cursor: pointer; transition: all 0.2s;
            display: flex; justify-content: center; align-items: center;
        }
        .speed-adjust-button:hover { background-color: #00ff00; color: #000; transform: scale(1.1); }
        #snake-selection select {
            background-color: transparent; color: #00ff00; border: 2px solid #00ff00; padding: 8px;
            font-family: 'Press Start 2P', cursive; font-size: 0.8rem; border-radius: 5px; cursor: pointer;
        }
        #snake-selection select:focus { outline: none; }
        #start-game-button {
            background-color: #00ff00; color: #000; border: none; padding: 10px 20px;
            font-family: 'Press Start 2P', cursive; font-size: 1rem; border-radius: 5px;
            cursor: pointer; transition: all 0.2s; width: 200px; margin-top: 15px;
        }
        #start-game-button:hover { background-color: #ffff00; transform: scale(1.05); }

        #highscore-container { text-align: center; width: 100%; font-size: 0.7rem; }
        #highscore-container h3 { margin-top: 0; margin-bottom: 15px; color: #ffff00; display: inline-block; margin-right: 10px;}
        #refresh-scores-button { background: none; border: none; font-size: 1rem; cursor: pointer; }
        .highscore-list { display: flex; justify-content: center; }
        .highscore-list ol { list-style-type: none; padding-left: 0; margin: 0; min-width: 250px; text-align: left; }
        .highscore-columns-shared { display: flex; justify-content: center; gap: 40px; text-align: left; }
        .highscore-columns-shared ol { list-style-type: none; padding-left: 0; margin: 0; min-width: 170px; }
        .highscore-list li, .highscore-columns-shared li { margin-bottom: 8px; color: #f0f0f0; }
        .highscore-list li span, .highscore-columns-shared li span { color: #ffff00; float: right; }

        .modal-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.8); display: none; justify-content: center;
            align-items: center; z-index: 100; border-radius: 10px;
        }
        .modal-content {
            color: #f0f0f0; background-color: #1a1a1a; padding: 30px; border-radius: 15px;
            border: 4px solid #555; text-align: center; box-shadow: 0 0 20px rgba(0, 0, 0, 0.8);
            max-width: 90%;
        }
        .modal-content h2 { margin-top: 0; font-size: 1.8rem; }
        #new-highscore-entry { margin: 20px 0; }
        #player-name {
            background-color: #333; border: 2px solid #00ff00; color: #f0f0f0; padding: 8px;
            font-family: 'Press Start 2P', cursive; text-align: center; width: 150px; text-transform: uppercase;
        }
        .modal-content button {
            background-color: #00ff00; color: #000; border: none; padding: 10px 20px;
            font-family: 'Press Start 2P', cursive; font-size: 1rem; border-radius: 5px;
            cursor: pointer; margin-top: 15px; transition: all 0.2s;
        }
        .modal-content button:hover { background-color: #ffff00; transform: scale(1.05); }

        /* Debug Panel */
        #debug-panel {
            position: fixed;
            bottom: 10px;
            left: 10px;
            background: rgba(0,0,0,0.7);
            border: 1px solid var(--primary-color);
            padding: 10px;
            border-radius: 5px;
            font-size: 0.7rem;
            color: white;
            z-index: 200;
            display: none; /* Initially hidden */
        }
        #debug-panel.visible { display: block; }
        #debug-panel-toggle { position: fixed; bottom: 10px; left: 10px; z-index: 201; opacity: 0.5; }
        #debug-panel h4 { margin: 0 0 10px 0; color: var(--primary-color); }
        #debug-panel p { margin: 4px 0; }
        #debug-panel select { background: #333; color: white; border: 1px solid #555; font-size: 0.7rem;}

        @media (max-width: 480px) {
            .game-container { padding: 15px; }
            #game-board { width: 100%; height: auto; aspect-ratio: 1 / 1; }
            h1 { font-size: 1.5rem; }
            .modal-content { padding: 20px;}
        }

    </style>
</head>
<body>
    <div class="game-container">
        <h1>ULAR</h1>
        <p id="game-version"></p>
        <!-- Main Menu Screen -->
        <div class="main-menu" id="main-menu">
            <div id="speed-selection" class="menu-section">
                <h2>PILIH KELAJUAN</h2>
                <div class="speed-control">
                    <button id="speed-down-button" class="speed-adjust-button">-</button>
                    <span id="speed-display">3</span>
                    <button id="speed-up-button" class="speed-adjust-button">+</button>
                </div>
            </div>
            <div id="snake-selection" class="menu-section">
                <h2>PILIH ULAR</h2>
                <select id="snake-type">
                    <option value="classic">Ular Klasik</option>
                    <option value="cobra">Ular Kobra</option>
                </select>
            </div>
            <button id="start-game-button">Mula Permainan</button>
            <div id="highscore-container">
                <h3>MARKAH TERTINGGI</h3><button id="refresh-scores-button">ðŸ”„</button>
                <div class="highscore-list">
                    <ol id="highscore-list"></ol>
                </div>
            </div>
        </div>

        <!-- Game Area (hidden initially) -->
        <div id="game-area" style="display: none;">
            <div id="bonus-stage-title" style="display: none;">PERINGKAT BONUS</div>
            <div id="game-info-container">
                <div class="info-box">Markah: <span id="score-value">0</span></div>
                <div class="info-box">Peringkat: <span id="stage-value">1</span></div>
            </div>
            <div id="game-board"></div>
              <!-- D-pad Controls -->
            <div id="dpad-controls">
                <div id="dpad-up" class="dpad-button"><svg viewBox="0 0 24 24"><path d="M12 8l-6 6h12z"/></svg></div>
                <div id="dpad-left" class="dpad-button"><svg viewBox="0 0 24 24"><path d="M15.41 16.59L10.83 12l4.58-4.59L14 6l-6 6 6 6z"/></svg></div>
                <div id="dpad-center"></div>
                <div id="dpad-right" class="dpad-button"><svg viewBox="0 0 24 24"><path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6z"/></svg></div>
                <div id="dpad-down" class="dpad-button"><svg viewBox="0 0 24 24"><path d="M12 16l6-6H6z"/></svg></div>
            </div>
            <div class="instructions-container">
                <p class="instructions">Guna Kekunci Anak Panah untuk Bergerak</p>
            </div>
        </div>
        
        <!-- Game Over Modal -->
        <div id="game-over-modal" class="modal-overlay">
            <div class="modal-content">
                <h2 style="color: #ff4136;">TAMAT PERMAINAN</h2>
                <p>Markah Anda: <span id="final-score">0</span></p>
                <div id="new-highscore-entry" style="display: none;">
                    <p>Markah Tinggi Baharu!</p>
                    <input type="text" id="player-name" maxlength="10" placeholder="MASUKKAN NAMA">
                    <button id="save-score-button">Simpan</button>
                </div>
                <div id="game-over-scores" style="display: none;">
                    <h3>MARKAH TERTINGGI</h3>
                    <div class="highscore-columns-shared" id="highscore-columns-gameover">
                        <ol id="gos-list-1"></ol> <ol id="gos-list-2"></ol>
                    </div>
                </div>
                <button id="restart-button">Main Semula</button>
            </div>
        </div>
    </div>
    
    <!-- Debug Panel -->
    <input type="checkbox" id="debug-panel-toggle" title="Toggle Debug Panel">
    <div id="debug-panel">
        <h4>PANEL DEBUG</h4>
        <p>Posisi Ular: <span id="debug-snake-pos">-</span></p>
        <p>Markah Semasa: <span id="debug-stage-score">-</span></p>
        <p>Jumlah Markah: <span id="debug-total-score">-</span></p>
        <div>
            <label for="debug-stage-select">Pilih Peringkat:</label>
            <select id="debug-stage-select"></select>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDocs, getDoc, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";
        window.firebase = {
            initializeApp, getAuth, signInAnonymously, getFirestore, collection, doc, setDoc, getDocs, getDoc, query, orderBy, limit
        };
    </script>

    <script>
    document.addEventListener('DOMContentLoaded', () => {

        // =================================================================
        // PEMBOLEH UBAH & TETAPAN UTAMA
        // =================================================================
        const GAME_VERSION = "1.0.3"; // Version updated for mobile control fix
        const PORTAL_REQUIREMENT_MULTIPLIER = 5;
        const OBSTACLE_REQUIREMENT = 20;

        const firebaseConfig = {
            apiKey: "AIzaSyBDuQgpyrVT-hOYucH51AATLxDRLaKWgpQ",
            authDomain: "retro-game-6d9c7.firebaseapp.com",
            projectId: "retro-game-6d9c7",
            storageBucket: "retro-game-6d9c7.firebasestorage.app",
            messagingSenderId: "258289584699",
            appId: "1:258289584699:web:d9228a2a2e3cbc0b41aa1e",
            measurementId: "G-G16BRQJB7D"
        };


        // =================================================================
        // KELAS-KELAS & LOGIK UTAMA
        // =================================================================

        const mazeGenerator = {
            generate() {
                const width = 20, height = 20;
                const grid = Array.from({ length: height }, () => Array(width).fill('W'));
                const stack = [{ x: 1, y: 1 }];
                grid[1][1] = 'P';
                
                while (stack.length > 0) {
                    const current = stack[stack.length - 1];
                    const neighbors = [];
                    const directions = [{ x: 0, y: -2 }, { x: 0, y: 2 }, { x: -2, y: 0 }, { x: 2, y: 0 }];
                    directions.sort(() => Math.random() - 0.5);

                    for (const dir of directions) {
                        const nx = current.x + dir.x, ny = current.y + dir.y;
                        if (nx > 0 && nx < width - 1 && ny > 0 && ny < height - 1 && grid[ny][nx] === 'W') {
                            neighbors.push({ x: nx, y: ny });
                        }
                    }

                    if (neighbors.length > 0) {
                        const next = neighbors[0];
                        grid[current.y + (next.y - current.y) / 2][current.x + (next.x - current.x) / 2] = 'P';
                        grid[next.y][next.x] = 'P';
                        stack.push(next);
                    } else {
                        stack.pop();
                    }
                }

                const mazeObjects = { walls: [], foods: [], start: { x: 1, y: 1 }, exit: { x: 18, y: 18 }};
                const paths = [];
                for (let y = 0; y < height; y++) {
                    for (let x = 0; x < width; x++) {
                        if (grid[y][x] === 'W') mazeObjects.walls.push({ x, y });
                        else paths.push({ x, y });
                    }
                }
                
                const foodPaths = paths.filter(p => !(p.x === 1 && p.y === 1) && !(p.x === 18 && p.y === 18));
                for (let i = 0; i < 15 && foodPaths.length > 0; i++) {
                    const randIndex = Math.floor(Math.random() * foodPaths.length);
                    mazeObjects.foods.push({ ...foodPaths.splice(randIndex, 1)[0] });
                }
                return mazeObjects;
            }
        };

        class ScoreManager {
            constructor() {
                this.scores = [];
            }
            getScores() { return this.scores; }
            
            async saveUserScore(db, userId, name, score) {
                if (!db || !userId) return;
                try {
                    const scoreRef = window.firebase.doc(db, 'games/snake/highscores', userId);
                    const docSnap = await window.firebase.getDoc(scoreRef);
                    if (docSnap.exists() && docSnap.data().score >= score) {
                        console.log("Markah sedia ada lebih tinggi, tidak disimpan.");
                        return;
                    }
                    await window.firebase.setDoc(scoreRef, { name, score });
                    console.log("Markah berjaya disimpan ke Firebase!");
                } catch (error) {
                    console.error("Ralat menyimpan markah:", error);
                }
            }

            async loadGlobalScores(db) {
                if (!db) return;
                try {
                    const q = window.firebase.query(window.firebase.collection(db, "games/snake/highscores"), window.firebase.orderBy("score", "desc"), window.firebase.limit(10));
                    const querySnapshot = await window.firebase.getDocs(q);
                    const firebaseScores = [];
                    querySnapshot.forEach((doc) => {
                        firebaseScores.push(doc.data());
                    });
                    this.scores = firebaseScores;
                } catch (error) {
                    console.error("Ralat memuatkan markah:", error);
                    // Fallback to local storage if firebase fails
                    this.scores = JSON.parse(localStorage.getItem('snakeHighScoresV4')) || [];
                }
            }
            isHighScore(score) {
                if (score <= 0) return false;
                if (this.scores.length < 10) return true;
                return score > this.scores[this.scores.length - 1].score;
            }
        }

        class UIManager {
            constructor() {
                this.boardElement = document.getElementById('game-board');
                this.gridSize = 20;
                this.mainMenu = document.getElementById('main-menu');
                this.gameArea = document.getElementById('game-area');
                this.gameOverModal = document.getElementById('game-over-modal');
                this.newHighscoreEntry = document.getElementById('new-highscore-entry');
                this.gameOverScores = document.getElementById('game-over-scores');
                this.scoreValue = document.getElementById('score-value');
                this.stageValue = document.getElementById('stage-value');
                this.bonusTitle = document.getElementById('bonus-stage-title');
                this.finalScore = document.getElementById('final-score');
                this.highscoreList = document.getElementById('highscore-list');
                this.gosList1 = document.getElementById('gos-list-1');
                this.gosList2 = document.getElementById('gos-list-2');
                this.playerNameInput = document.getElementById('player-name');
                this.debugPanel = document.getElementById('debug-panel');
                this.debugToggle = document.getElementById('debug-panel-toggle');
                this.debugSnakePos = document.getElementById('debug-snake-pos');
                this.debugStageScore = document.getElementById('debug-stage-score');
                this.debugTotalScore = document.getElementById('debug-total-score');
                this.gameVersionDisplay = document.getElementById('game-version');

                this.gameVersionDisplay.textContent = `v${GAME_VERSION}`;
                this.debugToggle.addEventListener('change', () => {
                    this.debugPanel.classList.toggle('visible');
                });
            }

            clearBoard() { this.boardElement.innerHTML = ''; }

            draw(gameState) {
                this.clearBoard();
                const cellSize = this.boardElement.clientWidth / this.gridSize;
                const { snake, food } = gameState;
                const currentStage = gameState.stages[gameState.currentStageIndex];

                if (!currentStage || !snake) return;

                if (currentStage instanceof BonusStage) {
                    currentStage.maze.walls.forEach(w => this.boardElement.appendChild(this._createEl(w.x, w.y, cellSize, 'maze-wall')));
                    currentStage.maze.foods.forEach(f => this.boardElement.appendChild(this._createEl(f.x, f.y, cellSize, 'food', 'ðŸŽ')));
                    const exitEl = this._createEl(currentStage.maze.exit.x, currentStage.maze.exit.y, cellSize, 'maze-exit', 'ðŸŒ€');
                    this.boardElement.appendChild(exitEl);
                } else {
                    currentStage.obstacles.forEach(obs => this.boardElement.appendChild(this._createEl(obs.x, obs.y, cellSize, 'obstacle')));
                    const foodEl = this._createEl(food.x, food.y, cellSize, 'food', food.emoji);
                    if (food.type === 'portal') foodEl.classList.add('portal');
                    this.boardElement.appendChild(foodEl);
                }
                
                snake.draw(this.boardElement, cellSize);
            }
            
            _createEl(gridX, gridY, cellSize, className, emoji = '') {
                const el = document.createElement('div');
                el.className = `game-object ${className}`;
                el.style.left = `${gridX * cellSize}px`;
                el.style.top = `${gridY * cellSize}px`;
                el.style.width = `${cellSize}px`;
                el.style.height = `${cellSize}px`;
                el.textContent = emoji;
                return el;
            }

            showMenu() { this.mainMenu.style.display = 'flex'; this.gameArea.style.display = 'none'; this.gameOverModal.style.display = 'none'; }
            showGame() { this.mainMenu.style.display = 'none'; this.gameArea.style.display = 'block'; this.gameOverModal.style.display = 'none'; }
            showGameOver(score, scores) {
                this.finalScore.textContent = score;
                this.displayHighScores(scores, { list1: this.gosList1, list2: this.gosList2, limit: 10 });
                this.gameOverModal.style.display = 'flex';
            }
            showNameInputForm() {
                this.newHighscoreEntry.style.display = 'block';
                this.gameOverScores.style.display = 'none';
                setTimeout(() => this.playerNameInput.focus(), 100);
            }
            hideNameInputForm() {
                this.newHighscoreEntry.style.display = 'none';
                this.gameOverScores.style.display = 'block';
            }
            updateGameUI(score, currentStage) {
                this.scoreValue.textContent = score;
                if (currentStage instanceof BonusStage) {
                    this.stageValue.textContent = 'BONUS';
                    this.bonusTitle.style.display = 'block';
                } else {
                    this.stageValue.textContent = currentStage.level;
                    this.bonusTitle.style.display = 'none';
                }
            }
            displayHighScores(scores, { list1, list2 = null, limit = 3, showMedals = false }) {
                const medals = ['ðŸ¥‡', 'ðŸ¥ˆ', 'ðŸ¥‰'];
                if (list2) { // Logic for two columns (game over)
                    list1.innerHTML = scores.slice(0, 5).map((s, i) => `<li>${i + 1}. ${s.name} <span>${s.score}</span></li>`).join('');
                    list2.innerHTML = scores.slice(5, 10).map((s, i) => `<li>${i + 6}. ${s.name} <span>${s.score}</span></li>`).join('');
                } else { // Logic for single list (main menu)
                    list1.innerHTML = scores.slice(0, limit).map((s, i) => {
                        const medal = showMedals ? medals[i] || '' : '';
                        return `<li>${medal} ${s.name} <span>${s.score}</span></li>`;
                    }).join('');
                }
            }
            updateDebugInfo(gameState) {
                if (!gameState.snake) return;
                const head = gameState.snake.body[0];
                this.debugSnakePos.textContent = `X:${head.x}, Y:${head.y}`;
                this.debugStageScore.textContent = gameState.score;
                this.debugTotalScore.textContent = gameState.totalScore;
            }
        }
        
        class BaseSnake {
            constructor(gridSize, styles, startPosOverride = null) {
                this.gridSize = gridSize;
                this.styles = styles;
                this.initialPos = startPosOverride || { x: Math.floor(gridSize / 2), y: Math.floor(gridSize / 2) };
                this.reset();
            }
            move() {
                const head = { x: this.body[0].x + this.dx, y: this.body[0].y + this.dy };
                this.body.unshift(head);
                if (this.isGrowing) this.isGrowing = false;
                else this.body.pop();
            }
            grow() { this.isGrowing = true; }
            changeDirection(newDx, newDy) {
                this.dx = newDx; this.dy = newDy;
            }
            checkCollision(obstacles) {
                const head = this.body[0];
                if (head.x < 0 || head.x >= this.gridSize || head.y < 0 || head.y >= this.gridSize) return true;
                for (let i = 1; i < this.body.length; i++) if (head.x === this.body[i].x && head.y === this.body[i].y) return true;
                for (const obs of obstacles) if (head.x === obs.x && head.y === obs.y) return true;
                return false;
            }
            draw(boardElement, cellSize) {
                this.body.forEach((segment, index) => {
                    let className = (index === 0) ? this.styles.head : (index === this.body.length - 1 && this.body.length > 1) ? this.styles.tail : this.styles.body;
                    boardElement.appendChild(this._createSegmentElement(segment, cellSize, className));
                });
            }
            _createSegmentElement(segment, cellSize, className) {
                const el = document.createElement('div');
                el.className = `game-object ${className}`;
                el.style.left = `${segment.x * cellSize}px`;
                el.style.top = `${segment.y * cellSize}px`;
                el.style.width = `${cellSize}px`;
                el.style.height = `${cellSize}px`;
                return el;
            }
            reset() {
                this.body = [{ x: this.initialPos.x, y: this.initialPos.y }];
                this.dx = 1; this.dy = 0; this.isGrowing = false;
            }
        }

        class ClassicSnake extends BaseSnake {
            constructor(gridSize, startPosOverride) { super(gridSize, { head: 'snake-head', body: 'snake-body', tail: 'snake-tail' }, startPosOverride); }
        }

        class CobraSnake extends BaseSnake {
            constructor(gridSize, startPosOverride) { super(gridSize, { head: 'cobra-head', body: 'cobra-body', tail: 'cobra-tail' }, startPosOverride); }
        }
        
        class Food {
            constructor(gridSize) {
                this.gridSize = gridSize;
                this.x = 0; this.y = 0;
                this.type = 'normal';
                this.emoji = 'ðŸŽ';
                this.timer = 0;
                this.maxTime = 0;
                this.FRUITS = ['ðŸŽ', 'ðŸŒ', 'ðŸ‡', 'ðŸŠ', 'ðŸ“'];
            }
            
            spawn(snakeBody, obstacles = [], stageLevel = 1, isPortal = false) {
                let valid;
                do {
                    valid = true;
                    this.x = Math.floor(Math.random() * this.gridSize);
                    this.y = Math.floor(Math.random() * this.gridSize);
                    if (snakeBody.some(s => s.x === this.x && s.y === this.y)) valid = false;
                    if (obstacles.some(o => o.x === this.x && o.y === this.y)) valid = false;
                } while (!valid);
                
                if (isPortal) {
                    this.transformToPortal();
                } else {
                    this.type = 'normal';
                    this.emoji = this.FRUITS[Math.floor(Math.random() * this.FRUITS.length)];
                    this.maxTime = (8 - Math.min(stageLevel, 7)) * 1000;
                    this.timer = this.maxTime;
                }
            }
            
            transformToPortal() {
                this.type = 'portal';
                this.emoji = 'ðŸŒ€';
                this.timer = Infinity;
            }
        }
        
        class BaseStage {
            constructor() {}
        }

        class NormalStage extends BaseStage {
            constructor(level) {
                super();
                this.level = level;
                this.obstacles = [];
            }
        }

        class BonusStage extends BaseStage {
            constructor() {
                super();
                this.maze = mazeGenerator.generate();
            }
        }

        class Game {
            constructor() {
                this.gridSize = 20;
                this.gameState = 'menu';
                this.speedMap = { 1: 220, 2: 185, 3: 150, 4: 125, 5: 100, 6: 85, 7: 70, 8: 60, 9: 50 };
                this.currentSpeedLevel = 3;
                
                this.scoreManager = new ScoreManager();
                this.uiManager = new UIManager();
                this.food = new Food(this.gridSize);
                
                this.stages = this.defineStages();
                
                this.db = null;
                this.auth = null;
                this.userId = null;
                
                this.initGameState();
                this.setupEventListeners();
                this.initializeFirebase();
            }

            async initializeFirebase() {
                try {
                    const app = window.firebase.initializeApp(firebaseConfig);
                    this.db = window.firebase.getFirestore(app);
                    this.auth = window.firebase.getAuth(app);
                    await window.firebase.signInAnonymously(this.auth);
                    this.userId = this.auth.currentUser.uid;
                    console.log("Firebase Berjaya Dimulakan. UID:", this.userId);
                    await this.refreshHighScores();
                } catch (error) {
                    console.error("Gagal memulakan Firebase:", error);
                    this.init(); // Teruskan dengan data tempatan jika gagal
                }
            }

            initGameState() {
                this.score = 0;
                this.totalScore = 0;
                this.currentStageIndex = 0;
                this.snake = null;
                this.isMoving = false;
                this.foodsEatenInStage = 0;
                this.foodsEatenForObstacle = 0;
                this.inputBuffer = []; 
            }

            init() {
                this.uiManager.displayHighScores(this.scoreManager.getScores(), { list1: this.uiManager.highscoreList, limit: 3, showMedals: true });
                this.uiManager.showMenu();
                document.getElementById('speed-display').textContent = this.currentSpeedLevel;
            }
            
            defineStages() {
                const stages = [];
                stages.push(new NormalStage(1));
                stages.push(new BonusStage());
                stages.push(new NormalStage(2));
                stages.push(new BonusStage());
                stages.push(new NormalStage(3));
                stages.push(new BonusStage());
                stages.push(new NormalStage(4));
                stages.push(new BonusStage());
                stages.push(new NormalStage(5));
                return stages;
            }

            setupEventListeners() {
                document.getElementById('start-game-button').addEventListener('click', () => this.startGame());
                document.getElementById('restart-button').addEventListener('click', () => { this.initGameState(); this.init(); });
                
                document.getElementById('save-score-button').addEventListener('click', async () => {
                    const name = this.uiManager.playerNameInput.value.trim().toUpperCase() || 'PEMAIN';
                    await this.scoreManager.saveUserScore(this.db, this.userId, name, this.totalScore);
                    this.uiManager.hideNameInputForm();
                    await this.refreshHighScores(true); 
                });

                document.getElementById('refresh-scores-button').addEventListener('click', () => this.refreshHighScores());

                document.getElementById('speed-up-button').addEventListener('click', () => this.changeSpeed(1));
                document.getElementById('speed-down-button').addEventListener('click', () => this.changeSpeed(-1));
                document.addEventListener('keydown', e => this.handleKeyPress(e.key));
                
                // PEMBETULAN: Menggunakan 'touchstart' untuk D-pad
                const dpadHandler = (e, key) => {
                    e.preventDefault(); // Mencegah 'click' dan skrol
                    this.handleKeyPress(key);
                };
                document.getElementById('dpad-up').addEventListener('touchstart', (e) => dpadHandler(e, 'ArrowUp'), { passive: false });
                document.getElementById('dpad-down').addEventListener('touchstart', (e) => dpadHandler(e, 'ArrowDown'), { passive: false });
                document.getElementById('dpad-left').addEventListener('touchstart', (e) => dpadHandler(e, 'ArrowLeft'), { passive: false });
                document.getElementById('dpad-right').addEventListener('touchstart', (e) => dpadHandler(e, 'ArrowRight'), { passive: false });

                // Debug Panel Listeners
                const stageSelect = document.getElementById('debug-stage-select');
                this.stages.forEach((stage, index) => {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = (stage instanceof BonusStage) ? `Bonus ${Math.floor(index/2)+1}` : `Peringkat ${stage.level}`;
                    stageSelect.appendChild(option);
                });
                stageSelect.addEventListener('change', (e) => {
                    this.jumpToStage(parseInt(e.target.value));
                });
            }

            async refreshHighScores(isGameOver = false) {
                await this.scoreManager.loadGlobalScores(this.db);
                if (isGameOver) {
                    this.uiManager.displayHighScores(this.scoreManager.getScores(), { list1: this.uiManager.gosList1, list2: this.uiManager.gosList2, limit: 10 });
                } else {
                    this.uiManager.displayHighScores(this.scoreManager.getScores(), { list1: this.uiManager.highscoreList, limit: 3, showMedals: true });
                }
            }
            
            changeSpeed(delta) {
                this.currentSpeedLevel = Math.max(1, Math.min(9, this.currentSpeedLevel + delta));
                document.getElementById('speed-display').textContent = this.currentSpeedLevel;
            }
            
            handleKeyPress(key) {
                if (this.gameState !== 'playing') return;

                const keyMap = {
                    'ArrowUp': { dx: 0, dy: -1 }, 'w': { dx: 0, dy: -1 },
                    'ArrowDown': { dx: 0, dy: 1 }, 's': { dx: 0, dy: 1 },
                    'ArrowLeft': { dx: -1, dy: 0 }, 'a': { dx: -1, dy: 0 },
                    'ArrowRight': { dx: 1, dy: 0 }, 'd': { dx: 1, dy: 0 }
                };

                if (keyMap[key]) {
                    if (!this.isMoving) {
                        this.isMoving = true;
                    }
                    if (this.inputBuffer.length < 2) {
                        this.inputBuffer.push(keyMap[key]);
                    }
                }
            }
            
            startGame() {
                this.initGameState();
                this.loadStage();
                this.gameState = 'playing';
                this.uiManager.showGame();
                this.gameLoop();
            }

            loadStage() {
                const currentStage = this.stages[this.currentStageIndex];
                const snakeType = document.getElementById('snake-type').value;
                this.isMoving = false; 
                this.inputBuffer = [];

                let startPos = null;
                if (currentStage instanceof BonusStage) {
                    startPos = currentStage.maze.start;
                }
                
                if (this.snake) {
                    this.snake.initialPos = startPos || { x: Math.floor(this.gridSize / 2), y: Math.floor(this.gridSize / 2) };
                    this.snake.reset();
                } else {
                    this.snake = (snakeType === 'cobra') ? new CobraSnake(this.gridSize, startPos) : new ClassicSnake(this.gridSize, startPos);
                }
                
                if (currentStage instanceof NormalStage) {
                    this.food.spawn(this.snake.body, currentStage.obstacles, currentStage.level);
                }
                this.uiManager.updateGameUI(this.totalScore, currentStage);
            }

            gameLoop() {
                if (this.gameState !== 'playing') return;
                
                const loopTime = this.speedMap[this.currentSpeedLevel];
                
                this.update();
                this.draw();

                setTimeout(() => this.gameLoop(), loopTime);
            }
            
            processInput() {
                if (this.inputBuffer.length > 0) {
                    const nextMove = this.inputBuffer[0];
                    const currentDirection = { dx: this.snake.dx, dy: this.snake.dy };
                    const isOpposite = (currentDirection.dx === -nextMove.dx && currentDirection.dx !== 0) || (currentDirection.dy === -nextMove.dy && currentDirection.dy !== 0);

                    if (!isOpposite) {
                        this.snake.changeDirection(nextMove.dx, nextMove.dy);
                    }
                    this.inputBuffer.shift();
                }
            }

            update() {
                const currentStage = this.stages[this.currentStageIndex];
                
                this.processInput();

                if (this.isMoving) {
                    if (currentStage instanceof NormalStage) {
                        this.food.timer -= this.speedMap[this.currentSpeedLevel];
                        if (this.food.timer <= 0) {
                            this.food.spawn(this.snake.body, currentStage.obstacles, currentStage.level, false);
                        }
                    }

                    this.snake.move();
                    const head = this.snake.body[0];
                    const scoreToAdd = this.currentSpeedLevel;
                    
                    if (currentStage instanceof BonusStage) {
                        if (this.snake.checkCollision(currentStage.maze.walls)) { this.nextStage(false); return; }
                        
                        const foodIndex = currentStage.maze.foods.findIndex(f => f.x === head.x && f.y === head.y);
                        if (foodIndex > -1) {
                            this.score += scoreToAdd;
                            this.totalScore += scoreToAdd;
                            this.snake.grow();
                            currentStage.maze.foods.splice(foodIndex, 1);
                        }
                        if (head.x === currentStage.maze.exit.x && head.y === currentStage.maze.exit.y) {
                            this.nextStage(true);
                        }
                    } else { // NormalStage
                        if (this.snake.checkCollision(currentStage.obstacles)) { this.gameOver(); return; }
                        
                        if (head.x === this.food.x && head.y === this.food.y) {
                            if (this.food.type === 'portal') {
                                this.nextStage(true);
                                return;
                            }

                            this.score += scoreToAdd;
                            this.totalScore += scoreToAdd;
                            this.snake.grow();
                            this.foodsEatenInStage++;

                            if (currentStage.level >= 5) {
                                this.foodsEatenForObstacle++;
                                if (this.foodsEatenForObstacle >= OBSTACLE_REQUIREMENT) {
                                    this.foodsEatenForObstacle = 0;
                                    const newObstacle = {};
                                    this.food.spawn.call(newObstacle, this.snake.body, currentStage.obstacles);
                                    currentStage.obstacles.push(newObstacle);
                                }
                            }

                            const shouldSpawnPortal = this.foodsEatenInStage >= PORTAL_REQUIREMENT_MULTIPLIER * currentStage.level;
                            this.food.spawn(this.snake.body, currentStage.obstacles, currentStage.level, shouldSpawnPortal);
                            if(shouldSpawnPortal) this.foodsEatenInStage = 0;
                        }
                    }
                }
                
                this.uiManager.updateGameUI(this.totalScore, currentStage);
                if (this.uiManager.debugPanel.classList.contains('visible')) {
                    this.uiManager.updateDebugInfo(this);
                }
            }
            
            nextStage(isSuccess = true) {
                const previousStage = this.stages[this.currentStageIndex];
                if (previousStage instanceof BonusStage && isSuccess) {
                    const nextStageIndex = this.currentStageIndex + 1;
                    if(nextStageIndex < this.stages.length) {
                        const nextStage = this.stages[nextStageIndex];
                        const bonusPoints = this.score * 10 * nextStage.level;
                        this.totalScore += bonusPoints;
                    }
                }
                
                if (this.currentStageIndex < this.stages.length - 1) {
                    this.currentStageIndex++;
                    this.score = 0; 
                    this.foodsEatenInStage = 0;
                    this.foodsEatenForObstacle = 0;
                    this.loadStage();
                } else {
                    alert("Tahniah! Anda telah menamatkan semua peringkat!");
                    this.gameOver();
                }
            }

            jumpToStage(stageIndex) {
                if (this.gameState !== 'playing') {
                    this.startGame();
                    setTimeout(() => this.performJump(stageIndex), 50);
                } else {
                    this.performJump(stageIndex);
                }
            }
            
            performJump(stageIndex) {
                this.currentStageIndex = stageIndex;
                this.score = 0;
                this.totalScore = 0;
                this.foodsEatenInStage = 0;
                this.foodsEatenForObstacle = 0;
                this.loadStage();
            }

            draw() { this.uiManager.draw(this); }

            async gameOver() {
                this.gameState = 'gameover';
                const isNewHighScore = this.scoreManager.isHighScore(this.totalScore);

                if (isNewHighScore) {
                    this.uiManager.showGameOver(this.totalScore, this.scoreManager.getScores());
                    this.uiManager.showNameInputForm();
                } else {
                    await this.refreshHighScores(true);
                    this.uiManager.showGameOver(this.totalScore, this.scoreManager.getScores());
                    this.uiManager.hideNameInputForm();
                }
            }
        }
        new Game();
    });
    </script>
</body>
</html>

