<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Ice Climber - Dev Kawalan</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        body { background-color: #1a1a1a; color: #f0f0f0; display: flex; align-items: center; justify-content: center; height: 100vh; margin: 0; font-family: 'Press Start 2P', cursive; }
        .main-container { display: flex; align-items: center; gap: 30px; }
        .game-column { display: flex; flex-direction: column; align-items: center; }
        .version-info-dev { font-size: 0.7rem; color: #888; margin-top: -15px; margin-bottom: 15px; }
        .game-wrapper { position: relative; }
        #game-canvas { background-color: #000; border: 4px solid #555; border-radius: 10px; display: block; }
        
        #on-screen-controls {
            position: absolute;
            bottom: 20px;
            left: 20px;
            right: 20px;
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            pointer-events: auto;
        }
        .d-pad { position: relative; width: 120px; height: 120px; }
        .d-pad-btn {
            position: absolute;
            width: 40px;
            height: 40px;
            background-color: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            color: rgba(255, 255, 255, 0.7);
            font-size: 1.5rem;
            -webkit-user-select: none; user-select: none;
            transition: background-color 0.1s;
        }
        .d-pad .up { top: 0; left: 40px; }
        .d-pad .left { top: 40px; left: 0; }
        .d-pad .right { top: 40px; left: 80px; }
        .d-pad .down { top: 80px; left: 40px; }

        .action-buttons { display: flex; gap: 15px; }
        .action-btn {
            width: 50px;
            height: 50px;
            background-color: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.4);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            color: rgba(255, 255, 255, 0.7);
             -webkit-user-select: none; user-select: none;
             transition: background-color 0.1s;
        }
        .d-pad-btn.pressed, .action-btn.pressed {
            background-color: rgba(255, 255, 255, 0.5);
        }
        .version-display-overlay {
            position: absolute;
            top: 15px;
            left: 20px;
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.7);
            text-shadow: 1px 1px #000;
            pointer-events: none;
        }
        .menu {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            color: #fff;
            text-shadow: 3px 3px #000;
        }
        .menu h2 { font-size: 2.5rem; margin-bottom: 30px; }
        .menu-option {
            font-size: 1.2rem;
            color: #fff;
            margin-top: 25px;
            padding: 10px;
            position: relative;
        }
        .menu-option.selected {
            color: #ffff00;
        }
        .instructions-text {
            font-size: 0.8rem;
            line-height: 1.8;
            max-width: 80%;
            text-align: left;
            margin-bottom: 30px;
        }
        .instructions-text span {
            color: #ffff00;
            display: inline-block;
            width: 120px; /* Lebarkan sedikit untuk teks baru */
        }
        #menu-cursor {
            position: absolute;
            width: 20px;
            height: 20px;
            display: none; /* Hidden by default */
        }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="game-column">
            <h1>Ice Climber (Dev Kawalan)</h1>
            <p class="version-info-dev">v-dev-ctrl-0.8</p>
            <div class="game-wrapper">
                <canvas id="game-canvas" width="400" height="600"></canvas>
                <div id="hud-version" class="version-display-overlay">v-dev-ctrl-0.8</div>
                <div id="start-menu" class="menu">
                    <h2>ICE CLIMBER</h2>
                    <div id="start-button" class="menu-option" data-index="0">MULA</div>
                    <div id="instructions-button" class="menu-option" data-index="1">ARAHAN</div>
                </div>
                <div id="instructions-menu" class="menu" style="display: none;">
                    <h2>ARAHAN</h2>
                    <div class="instructions-text">
                        <p><span>Anak Panah</span> : Bergerak/Lompat</p>
                        <p><span>D / Butang A</span> : Pilih</p>
                        <p><span>S / Butang B</span> : Kembali</p>
                    </div>
                    <button class="menu-option" data-index="0">KEMBALI</button>
                </div>
                <div id="on-screen-controls">
                    <div class="d-pad">
                        <div id="btn-up" class="d-pad-btn up">&#9652;</div>
                        <div id="btn-left" class="d-pad-btn left">&#9664;</div>
                        <div id="btn-right" class="d-pad-btn right">&#9654;</div>
                        <div id="btn-down" class="d-pad-btn down">&#9662;</div>
                    </div>
                    <div class="action-buttons">
                        <div id="btn-b" class="action-btn">B</div>
                        <div id="btn-a" class="action-btn">A</div>
                    </div>
                </div>
                <div id="menu-cursor"></div>
            </div>
        </div>
    </div>

    <script>
        const Game = {
            // --- CORE MODULE: Main game loop and state management ---
            Core: {
                animationFrameId: null,
                init: function() {
                    Game.Controls.setupEventListeners();
                    Game.Level.generatePlatforms();
                    this.resetStage();
                    Game.Controls.updateActiveMenu(); // Set initial menu
                    this.gameLoop();
                },
                gameLoop: function() {
                    Game.Core.update();
                    Game.Graphics.draw();
                    Game.Core.animationFrameId = requestAnimationFrame(Game.Core.gameLoop);
                },
                update: function() {
                    Game.State.globalAnimationTick++;
                    if (!Game.State.isMenuVisible) {
                        if (Game.State.player.platformToDropThrough && Game.State.player.y > Game.State.player.platformToDropThrough.y + Game.Constants.PLATFORM_HEIGHT) {
                            Game.State.player.platformToDropThrough = null;
                        }
                        if (Game.State.player.actionBlinkTimer > 0) {
                            Game.State.player.actionBlinkTimer--;
                        } else {
                            Game.State.player.isActionBlinking = false;
                        }
                        Game.Player.handlePlayerInput();
                        Game.Player.updatePlayerPosition();
                        Game.Player.checkPlayerCollisions();
                    } else {
                        Game.Graphics.updateMenuCursor();
                    }
                },
                resetStage: function() {
                    const player = Game.State.player;
                    const floor = Game.State.platforms[0];
                    player.x = 20;
                    player.y = floor.y - player.height;
                    player.dx = 0;
                    player.dy = 0;
                    player.onGround = true;
                    player.isCrouching = false;
                    player.platformToDropThrough = null;
                }
            },

            // --- CONSTANTS MODULE ---
            Constants: {
                GRAVITY: 0.5,
                JUMP_POWER: -12,
                PLATFORM_HEIGHT: 15,
                VERTICAL_GAP: 120,
            },

            // --- STATE MODULE ---
            State: {
                canvas: document.getElementById('game-canvas'),
                ctx: document.getElementById('game-canvas').getContext('2d'),
                startMenu: document.getElementById('start-menu'),
                instructionsMenu: document.getElementById('instructions-menu'),
                menuCursor: document.getElementById('menu-cursor'),
                menuOptions: null,
                activeMenu: null,
                globalAnimationTick: 0,
                player: { 
                    width: 30, height: 30, x: 20, y: 530, dx: 0, dy: 0, 
                    onGround: true, standingOnPlatform: null,
                    isCrouching: false,
                    canDropDown: true,
                    platformToDropThrough: null,
                    isActionBlinking: false,
                    actionBlinkTimer: 0
                },
                platforms: [],
                playerSpeed: 3,
                canJump: true,
                jumpDelay: 500,
                isMenuVisible: true,
                currentMenuSelection: 0,
            },
            
            // --- LEVEL MODULE (Simplified) ---
            Level: {
                generatePlatforms: function() {
                    const C = Game.Constants;
                    Game.State.platforms = [
                        { x: 0, y: 560, width: 400, height: 40 },
                        { x: 150, y: 460, width: 200, height: C.PLATFORM_HEIGHT },
                        { x: 50, y: 360, width: 150, height: C.PLATFORM_HEIGHT },
                    ];
                },
            },

            // --- PLAYER MODULE (Full logic) ---
            Player: {
                handlePlayerInput: function() {
                    const player = Game.State.player;
                    const keys = Game.Controls.keys;
                    
                    player.isCrouching = (keys.down && player.onGround);

                    if (keys.left) { player.dx = -Game.State.playerSpeed; }
                    else if (keys.right) { player.dx = Game.State.playerSpeed; }
                    else { player.dx = 0; }

                    if (keys.up && player.onGround && Game.State.canJump) {
                        if (player.isCrouching && player.standingOnPlatform && player.standingOnPlatform !== Game.State.platforms[0] && player.canDropDown) {
                            player.dy = -2;
                            player.onGround = false;
                            player.platformToDropThrough = player.standingOnPlatform;
                            player.canDropDown = false;
                            setTimeout(() => { player.canDropDown = true; }, 300);
                        } else if (!player.isCrouching) {
                            player.dy = Game.Constants.JUMP_POWER;
                            player.onGround = false;
                            Game.State.canJump = false;
                            setTimeout(() => { Game.State.canJump = true; }, Game.State.jumpDelay);
                        }
                    }
                    
                    if (keys.b && !player.isActionBlinking) {
                        // TODO: Gantikan dengan mekanik block/pound
                        player.isActionBlinking = true;
                        player.actionBlinkTimer = 15; // Blink for 15 frames
                    }
                },
                updatePlayerPosition: function() {
                    const player = Game.State.player;
                    player.dy += Game.Constants.GRAVITY;
                    player.x += player.dx;
                    player.y += player.dy;
                    if (player.x + player.width < 0) { player.x = Game.State.canvas.width; }
                    else if (player.x > Game.State.canvas.width) { player.x = -player.width; }
                },
                checkPlayerCollisions: function() {
                    const player = Game.State.player;
                    player.onGround = false;
                    player.standingOnPlatform = null;
                    
                    for (const platform of Game.State.platforms) {
                        if(player.platformToDropThrough === platform) continue;

                        if (player.x + player.width > platform.x && player.x < platform.x + platform.width && player.dy >= 0 && player.y + player.height >= platform.y && (player.y + player.height - player.dy) <= platform.y) {
                            player.dy = 0;
                            player.onGround = true;
                            player.y = platform.y - player.height;
                            player.standingOnPlatform = platform;
                        }
                    }
                }
            },

            // --- GRAPHICS MODULE ---
            Graphics: {
                draw: function() {
                    this.drawBackground();
                    Game.State.platforms.forEach(p => { Game.State.ctx.fillStyle = '#A8D8F0'; Game.State.ctx.fillRect(p.x, p.y, p.width, p.height); });
                    this.drawCharacter('ESKIMO', Game.State.player.x, Game.State.player.y, Game.State.player.isCrouching);
                },
                updateMenuCursor: function() {
                    const S = Game.State;
                    if (!S.menuOptions || S.menuOptions.length === 0) {
                        S.menuCursor.style.display = 'none';
                        return;
                    }

                    S.menuOptions.forEach((opt, index) => {
                        opt.classList.toggle('selected', index === S.currentMenuSelection);
                    });

                    const selectedOption = S.menuOptions[S.currentMenuSelection];
                    if (selectedOption) {
                        S.menuCursor.style.display = 'block';
                        const optionRect = selectedOption.getBoundingClientRect();
                        const wrapperRect = S.canvas.parentElement.getBoundingClientRect();
                        
                        S.menuCursor.style.left = `${selectedOption.offsetLeft - 30}px`;
                        S.menuCursor.style.top = `${selectedOption.offsetTop + selectedOption.offsetHeight / 2 - 10}px`;
                    }
                },
                drawCharacter: function(charType, x, y, isCrouching = false, targetCtx = Game.State.ctx) {
                    const player = Game.State.player;
                    if (player.isActionBlinking && Math.floor(Game.State.globalAnimationTick / 4) % 2 === 0) {
                        return; // Skip drawing to create a blink effect
                    }
                    let heightModifier = isCrouching ? 6 : 0;
                    let yOffset = isCrouching ? 6 : 0;
                    switch (charType) {
                        case 'ESKIMO':
                            targetCtx.fillStyle = '#8B4513'; targetCtx.fillRect(x + 2, y + yOffset, player.width - 4, player.height - 2 - heightModifier);
                            targetCtx.fillStyle = '#4682B4'; targetCtx.fillRect(x, y + player.height - 8, player.width, 5);
                            targetCtx.fillStyle = '#FFDAB9'; targetCtx.fillRect(x + 7, y + 5 + yOffset, player.width - 14, 12 - heightModifier);
                            targetCtx.fillStyle = '#000000'; targetCtx.fillRect(x + 10, y + 10 + yOffset, 3, 3); targetCtx.fillRect(x + 17, y + 10 + yOffset, 3, 3);
                            if (!isCrouching) {
                                targetCtx.fillStyle = '#8B4513'; const armY = y + 15; const animOffset = Math.sin(Game.State.globalAnimationTick * 0.2) * 3;
                                targetCtx.fillRect(x - 2, armY + animOffset, 4, 8); targetCtx.fillRect(x + player.width - 2, armY - animOffset, 4, 8);
                            }
                            const legY = y + player.height - 2; targetCtx.fillRect(x + 5, legY, 8, 5); targetCtx.fillRect(x + player.width - 13, legY, 8, 5);
                            break;
                    }
                },
                drawBackground: function() {
                    const ctx = Game.State.ctx; const canvas = Game.State.canvas;
                    const sky = ctx.createLinearGradient(0, 0, 0, canvas.height);
                    sky.addColorStop(0, '#0c1445'); sky.addColorStop(1, '#346888');
                    ctx.fillStyle = sky; ctx.fillRect(0, 0, canvas.width, canvas.height);
                },
            },
            
            // --- CONTROLS MODULE ---
            Controls: {
                keys: { left: false, right: false, up: false, down: false, a: false, b: false },
                updateActiveMenu: function() {
                    const S = Game.State;
                    if (S.startMenu.style.display !== 'none') {
                        S.activeMenu = S.startMenu;
                    } else if (S.instructionsMenu.style.display !== 'none') {
                        S.activeMenu = S.instructionsMenu;
                    } else {
                        S.activeMenu = null;
                    }

                    if (S.activeMenu) {
                        S.menuOptions = S.activeMenu.querySelectorAll('.menu-option');
                        S.currentMenuSelection = 0;
                    }
                },
                handleMenuAction: function() {
                    const S = Game.State;
                    if (!S.isMenuVisible || !S.menuOptions) return;
                    
                    const selectedOption = S.menuOptions[S.currentMenuSelection];
                    if (!selectedOption) return;

                    if (S.activeMenu === S.startMenu) {
                        if (selectedOption.id === 'start-button') {
                            S.isMenuVisible = false;
                            S.startMenu.style.display = 'none';
                            S.menuCursor.style.display = 'none';
                            Game.Core.resetStage();
                        } else if (selectedOption.id === 'instructions-button') {
                            S.startMenu.style.display = 'none';
                            S.instructionsMenu.style.display = 'flex';
                            this.updateActiveMenu();
                        }
                    } else if (S.activeMenu === S.instructionsMenu) {
                        if (selectedOption.textContent === 'KEMBALI') {
                            S.instructionsMenu.style.display = 'none';
                            S.startMenu.style.display = 'flex';
                            this.updateActiveMenu();
                        }
                    }
                },
                setupEventListeners: function() {
                    document.addEventListener('keydown', (e) => {
                        const S = Game.State;
                        const key = e.key.toLowerCase();
                        if (S.isMenuVisible) {
                            e.preventDefault();
                            if (key === 'arrowdown') { S.currentMenuSelection = (S.currentMenuSelection + 1) % S.menuOptions.length; }
                            if (key === 'arrowup') { S.currentMenuSelection = (S.currentMenuSelection - 1 + S.menuOptions.length) % S.menuOptions.length; }
                            if (key === 'd' || key === 'enter') { this.handleMenuAction(); }
                            if (key === 's' && S.activeMenu === S.instructionsMenu) { this.handleMenuAction(); }
                        } else {
                            if (key === 'arrowleft') this.keys.left = true;
                            if (key === 'arrowright') this.keys.right = true;
                            if (key === 'arrowup' || key === 'd') { e.preventDefault(); this.keys.up = true; }
                            if (key === 'arrowdown') this.keys.down = true;
                            if (key === 's') this.keys.b = true;
                        }
                    });
                    document.addEventListener('keyup', (e) => {
                        const key = e.key.toLowerCase();
                        if (key === 'arrowleft') this.keys.left = false;
                        if (key === 'arrowright') this.keys.right = false;
                        if (key === 'arrowup' || key === 'd') { this.keys.up = false; }
                        if (key === 'arrowdown') this.keys.down = false;
                        if (key === 's') this.keys.b = false;
                    });

                    const btnLeft = document.getElementById('btn-left');
                    const btnRight = document.getElementById('btn-right');
                    const btnUp = document.getElementById('btn-up');
                    const btnDown = document.getElementById('btn-down');
                    const btnA = document.getElementById('btn-a');
                    const btnB = document.getElementById('btn-b');

                    const handleTouch = (element, key, isPressed) => {
                        element.addEventListener(isPressed ? 'touchstart' : 'touchend', (e) => {
                            e.preventDefault();
                            if (Game.State.isMenuVisible) {
                                if (isPressed) {
                                    const S = Game.State;
                                    if (key === 'up') S.currentMenuSelection = (S.currentMenuSelection - 1 + S.menuOptions.length) % S.menuOptions.length;
                                    if (key === 'down') S.currentMenuSelection = (S.currentMenuSelection + 1) % S.menuOptions.length;
                                    if (key === 'a') this.handleMenuAction();
                                    if (key === 'b' && S.activeMenu === S.instructionsMenu) { this.handleMenuAction(); }
                                }
                            } else {
                                this.keys[key] = isPressed;
                            }
                            element.classList.toggle('pressed', isPressed);
                        }, { passive: false });
                    };

                    handleTouch(btnLeft, 'left', true); handleTouch(btnLeft, 'left', false);
                    handleTouch(btnRight, 'right', true); handleTouch(btnRight, 'right', false);
                    handleTouch(btnDown, 'down', true); handleTouch(btnDown, 'down', false);
                    handleTouch(btnUp, 'up', true); handleTouch(btnUp, 'up', false);
                    handleTouch(btnA, 'a', true); handleTouch(btnA, 'a', false);
                    handleTouch(btnB, 'b', true); handleTouch(btnB, 'b', false);
                }
            },
        };

        window.onload = function() { Game.Core.init(); };
    </script>
</body>
</html>

