<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Keluarga App: Lukisan Kreatif (V3.7.7 - Stabil)</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@700&display=swap');

        :root {
            --bg-color: #f0f2f5;
            --toolbar-bg: #ffffff;
            --canvas-bg: #ffffff;
            --primary-color: #2196F3;
            --shadow-color: rgba(0, 0, 0, 0.15);
        }

        body {
            font-family: 'Nunito', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
            margin: 0;
            background-color: var(--bg-color);
            overflow: hidden;
            touch-action: none;
        }

        #toolbar-wrapper {
            position: relative;
            width: 100%;
            z-index: 1000;
        }

        #toolbar {
            width: 100%;
            background-color: var(--toolbar-bg);
            box-shadow: 0 4px 8px var(--shadow-color);
            padding: 5px 10px;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            gap: 10px;
            box-sizing: border-box;
            transition: padding 0.3s ease;
        }
        
        #toolbar-toggle {
            position: absolute;
            bottom: -30px;
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            height: 30px;
            background: var(--toolbar-bg);
            border: none;
            border-bottom-left-radius: 15px;
            border-bottom-right-radius: 15px;
            box-shadow: 0 4px 8px var(--shadow-color);
            cursor: pointer;
            z-index: 999;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        #toolbar-toggle svg { transition: transform 0.3s ease; }
        
        #toolbar-wrapper.hidden #toolbar { justify-content: space-between; padding: 5px 20px; flex-wrap: nowrap; }
        #toolbar-wrapper.hidden .tool-group:not(.quick-tool) { display: none; }
        #toolbar-wrapper.hidden #toolbar-toggle svg { transform: rotate(180deg); }

        .tool-group { display: flex; align-items: center; gap: 8px; }
        .tool-group label { font-weight: 700; font-size: 0.9em; }

        .tool-btn, .file-btn, .size-preset-btn {
            width: 38px; height: 38px; border-radius: 50%; border: 3px solid transparent;
            cursor: pointer; transition: all 0.2s ease;
            background-color: #eee; background-size: 55%; background-repeat: no-repeat; background-position: center;
            display: flex; justify-content: center; align-items: center; font-weight: bold;
        }
        .tool-btn:hover, .file-btn:hover, .size-preset-btn:hover { transform: scale(1.1); }
        .tool-btn:disabled, .file-btn:disabled, .size-preset-btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }
        .tool-btn.active, .size-preset-btn.active { border-color: var(--primary-color); box-shadow: 0 0 10px var(--primary-color); }
        
        /* Icons */
        #brush-btn { background-image: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9ImN1cnJlbnRDb2xvciIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiIGNsYXNzPSJsdWNpZGUgbHVjaWRlLXBhaW50YnJ1c2giPjxwYXRoIGQ9Ik0xNyAzYTIuODUgMi44NSAwIDAgMCA0IDRMMTMuNSAxOS41Yy0yLjA5IDIuMDktNi4wNCAyLjA5LTguMTQgMEE1LjU0IDUuNTQgMCAwIDEgMiA4LjM1VjVjMC0xLjEuOS0yIDItMmgzLjM1YTUuNTQgNS41NCAwIDAgMSAzLjE4IDEuMzVaIi8+PC9zdmc+'); }
        #pan-btn { background-image: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9ImN1cnJlbnRDb2xvciIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiIGNsYXNzPSJsdWNpZGUgbHVjaWRlLWhhbmQiPjxwYXRoIGQ9Im0xOCAxNS02LTZoNi02Ii8+PHBhdGggZD0iTTUgMTUtMiAydi00bDIgMiIvPjxwYXRoIGQ9Im0yIDEyIDMtMyA0IDQiLz48cGF0aCBkPSJtMSAxIDYgNiIvPjxwYXRoIGQ9Ik0xMiAyMiY5LTkgOS05Ii8+PC9zdmc+'); }
        #eraser-btn { background-image: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9ImN1cnJlbnRDb2xvciIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiIGNsYXNzPSJsdWNpZGUgbHVjaWRlLWVyYXNlciI+PHBhdGggZD0ibTIxIDExLTgtOEw2IDEzbDgtOCIvPjxwYXRoIGQ9Ik0xOSA5bDIuMiAyLjJjLjU4LjU4LjU4IDEuNTIgMCAyLjEybC01LjcgNS43Yy0uNTguNTgtMS41Mi41OC0yLjEyIDBMMTMgMTciLz48cGF0aCBkPSJtOSA4IDEuNSA1LjMiLz48cGF0aCBkPSJNMTIgN2gtNS41Yy0xLjQgMC0yLjUgMS4xLTIuNSAyLjVTNSAxMiA2LjUgMTJIMTQiLz48L3N2Zz4='); }
        #bucket-btn { background-image: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9ImN1cnJlbnRDb2xvciIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiIGNsYXNzPSJsdWNpZGUgbHVjaWRlLXBhaW50LWJ1Y2tldCI+PHBhdGggZD0ibTggMmwyLTJoNC41bDItMiIvPjxwYXRoIGQ9Im0xMiA2IDUtMiIvPjxwYXRoIGQ9Ik0yMiAxNGE0IDQgMCAwIDEtNCA0SDZhNCA0IDAgMCAxLTQtNFY3aDEwLjUiLz48cGF0aCBkPSJNNiA3aDIuMiIvPjwvc3ZnPg=='); }
        #undo-btn { background-image: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9ImN1cnJlbnRDb2xvciIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiIGNsYXNzPSJsdWNpZGUgbHVjaWRlLXVuZG8iPjxwYXRoIGQ9Ik0zIDdoNnY2Ii8+PHBhdGggZD0iTTIxIDE3QTkgOSAwIDAgMCA3LjM2IDdsLTMuMzYtNCIvPjwvc3ZnPg=='); }
        #redo-btn { background-image: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9ImN1cnJlbnRDb2xvciIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiIGNsYXNzPSJsdWNpZGUgbHVjaWRlLXJlZG8iPjxwYXRoIGQ9Ik0yMSA3aC02VjEiLz48cGF0aCBkPSJNOSAxN0E5IDkgMCAwIDAgMTYuNjQgNy4zbDMuMzYtNCIvPjwvc3ZnPg=='); }
        #rect-tool-btn { background-image: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9ImN1cnJlbnRDb2xvciIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiIGNsYXNzPSJsdWNpZGUgbHVjaWRlLXJlY3RhbmdsZSI+PHJlY3Qgd2lkdGg9IjE4IiBoZWlnaHQ9IjE4IiB4PSIzIiB5PSIzIiByeD0iMiIvPjwvc3ZnPg=='); }
        #line-tool-btn { background-image: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9ImN1cnJlbnRDb2xvciIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiPjxsaW5lIHgxPSI1IiB5MT0iMTIiIHgyPSIxOSIgeTI9IjEyIj48L2xpbmU+PC9zdmc+'); }
        #circle-tool-btn { background-image: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9ImN1cnJlbnRDb2xvciIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiPjxjaXJjbGUgY3g9IjEyIiBjeT0iMTIiIHI9IjEwIi8+PC9zdmc+'); }
        #open-project-btn { background-image: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9ImN1cnJlbnRDb2xvciIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiIGNsYXNzPSJsdWNpZGUgbHVjaWRlLWZvbGRlci1vcGVuIj48cGF0aCBkPSJtNiA5IDgtMy4yQTUuMTIgNS4xMiAwIDAgMSAxOSAyVjdoLTEiLz48cGF0aCBkPSJNMTkgMTJWNWEyIDIgMCAwIDAtMi0ySDVhMiAyIDAgMCAwLTIgMnYxNGMwIDEuMS45IDIgMiAyaDE0Ii8+PC9zdmc+');}
        #save-project-btn { background-image: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9ImN1cnJlbnRDb2xvciIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiIGNsYXNzPSJsdWNpZGUgbHVjaWRlLXNhdmUiPjxwYXRoIGQ9Ik0xOSAyMUg1Yy0xLjEgMC0yLS45LTItMlY1YzAtMS4xLjktMiAyLTJoMTEubDUtNSIvPjxwYXRoIGQ9Ik0xNyAyMVYxM0g3djhoMTBaIi8+PHBhdGggZD0iTTcgM3Y1aDhsMi0ySDdaIi8+PC9zdmc+');}
        #open-bg-image-btn { background-image: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9ImN1cnJlbnRDb2xvciIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiIGNsYXNzPSJsdWNpZGUgbHVjaWRlLWltYWdlIj48cmVjdCB3aWR0aD0iMTgiIGhlaWdodD0iMTgiIHg9IjMiIHk9IjMiIHJ4PSIyIiByeT0iMiIvPjxjaXJjbGUgY3g9IjguNSIgY3k9IjguNSIgcj0iMS41Ii8+PHBvbHlsaW5lIHBvaW50cz0iMjEgMTUgMTYgMTAgNSAyMSIvPjwvc3ZnPg==');}
        #save-png-btn { background-image: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9ImN1cnJlbnRDb2xvciIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiIGNsYXNzPSJsdWNpZGUgbHVjaWRlLWRvd25sb2FkIj48cGF0aCBkPSJNMjEgMTV2NGMwIDEuMS0uOSAyLTIgMkg1Yy0xLjEgMC0yLS45LTItMlYxNSIvPjxwYXRoIGQ9Ik03IDEwbDUgNSA1LTUiLz48cGF0aCBkPSJNMTIgMTVWM20wIDAiLz48L3N2Zz4=');}

        #color-picker { width: 38px; height: 38px; border: none; padding: 0; border-radius: 50%; overflow: hidden; cursor: pointer; }
        #color-picker::-webkit-color-swatch-wrapper { padding: 0; }
        #color-picker::-webkit-color-swatch { border: none; }
        .color-swatch { width: 24px; height: 24px; border: 2px solid #ccc; border-radius: 50%; cursor: pointer; }
        
        #size-slider, #opacity-slider { width: 80px; }
        #size-display, #opacity-display { font-weight: 700; min-width: 35px; text-align: right; }

        #main-content { display: flex; width: 100%; flex-grow: 1; overflow: hidden; }

        #canvas-container { flex-grow: 1; box-sizing: border-box; position: relative; background-color: var(--bg-color); overflow: hidden; }
        #canvas-container.panning { cursor: grabbing; }
        #canvas-container.drawing { cursor: none; }

        #canvas-wrapper { position: relative; box-shadow: 0 0 15px var(--shadow-color); transform-origin: 0 0; }
        .checkerboard-bg {
            background-image:
                linear-gradient(45deg, #ccc 25%, transparent 25%),
                linear-gradient(-45deg, #ccc 25%, transparent 25%),
                linear-gradient(45deg, transparent 75%, #ccc 75%),
                linear-gradient(-45deg, transparent 75%, #ccc 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
        }
        
        .canvas-layer, #preview-canvas { position: absolute; top: 0; left: 0; pointer-events: none; background-color: transparent; }
        #preview-canvas { pointer-events: auto; z-index: 100; }

        #custom-cursor { position: absolute; border: 1px solid #333; border-radius: 50%; pointer-events: none; transform: translate(-50%, -50%); display: none; }

        #layers-dropdown, #brush-type-select { height: 38px; border-radius: 5px; border: 2px solid #ccc; font-weight: 700; background-color: white; padding: 0 5px;}

        .layer-control-btn { width: 32px; height: 32px; border: none; background-color: #eee; border-radius: 5px; cursor: pointer; font-size: 1.2em; }
        #layers-dropdown option.hidden-layer { color: #999; }

        .dialog-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); display: flex; justify-content: center; align-items: center; z-index: 200; animation: fade-in 0.3s ease; }
        .dialog-box { background-color: white; padding: 30px; border-radius: 12px; text-align: center; box-shadow: 0 8px 16px rgba(0,0,0,0.2); max-width: 400px; width: 90%; }
        .dialog-message { font-size: 1.2em; margin-bottom: 20px; }
        .dialog-btn { padding: 10px 20px; font-size: 1em; font-weight: 700; cursor: pointer; border: none; border-radius: 8px; color: white; margin: 0 10px; }
        #confirm-yes, #prompt-save, .startup-btn { background-color: var(--primary-color); }
        #confirm-no, #prompt-cancel { background-color: #757575; }
        #new-project-options { margin-top: 20px; display: flex; justify-content: center; gap: 15px; }
        #new-project-options button { padding: 10px 15px; font-size: 1em; }
        
        #prompt-input { width: 100%; padding: 10px; box-sizing: border-box; border-radius: 8px; border: 1px solid #ccc; font-size: 1em; margin-bottom: 20px; }
        @keyframes fade-in { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>
    <div id="toolbar-wrapper" style="visibility: hidden;"> <!-- Sembunyikan toolbar pada mulanya -->
        <div id="toolbar">
            <div class="tool-group">
                <label>Alat:</label>
                <button id="bucket-btn" class="tool-btn" data-tool="bucket" title="Isian"></button>
            </div>
            <div class="tool-group quick-tool">
                <button id="brush-btn" class="tool-btn active" data-tool="brush" title="Berus"></button>
                <button id="eraser-btn" class="tool-btn" data-tool="eraser" title="Pemadam"></button>
            </div>
            <div class="tool-group">
                <button id="line-tool-btn" class="tool-btn" data-tool="line" title="Garisan"></button>
                <button id="rect-tool-btn" class="tool-btn" data-tool="rectangle" title="Segi Empat"></button>
                <button id="circle-tool-btn" class="tool-btn" data-tool="circle" title="Bulatan"></button>
                <button id="pan-btn" class="tool-btn" data-tool="pan" title="Alih"></button>
            </div>
             <div class="tool-group">
                <label>Jenis Berus:</label>
                <select id="brush-type-select">
                    <option value="round">Bulat</option>
                    <option value="square">Segi Empat</option>
                    <option value="spray">Semburan</option>
                </select>
            </div>
            <div class="tool-group">
                <label>Fail:</label>
                <button id="open-project-btn" class="file-btn" title="Buka Projek (.jan)"></button>
                <button id="save-project-btn" class="file-btn" title="Simpan Projek (.jan)"></button>
                <button id="open-bg-image-btn" class="file-btn" title="Buka Imej Panduan"></button>
                <button id="save-png-btn" class="file-btn" title="Simpan sebagai PNG"></button>
            </div>
            <div class="tool-group">
                <label>Warna:</label>
            </div>
            <div class="tool-group quick-tool">
                <input type="color" id="color-picker" value="#000000">
                <div id="prev-color-1" class="color-swatch" style="background-color: #ffffff;"></div>
                <div id="prev-color-2" class="color-swatch" style="background-color: #ffffff;"></div>
            </div>
             <div class="tool-group">
                <label>Lutsinar:</label>
                <input type="range" id="opacity-slider" min="0" max="1" value="1" step="0.01">
                <span id="opacity-display">100%</span>
            </div>
            <div class="tool-group">
                <label>Saiz:</label>
                <input type="range" id="size-slider" min="1" max="100" value="15">
                <span id="size-display">15</span>
                <button class="size-preset-btn" data-size="5">S</button>
                <button class="size-preset-btn active" data-size="15">M</button>
                <button class="size-preset-btn" data-size="30">L</button>
            </div>
            <div class="tool-group">
                <label>Lapisan:</label>
                <button id="move-layer-up-btn" class="layer-control-btn" title="Naikkan Lapisan">‚Üë</button>
                <button id="move-layer-down-btn" class="layer-control-btn" title="Turunkan Lapisan">‚Üì</button>
            </div>
            <div class="tool-group quick-tool">
                <select id="layers-dropdown"></select>
                <button id="visibility-btn" class="layer-control-btn" title="Tukar Keterlihatan">üëÅÔ∏è</button>
            </div>
            <div class="tool-group">
                <button id="add-layer-btn" class="layer-control-btn" title="Tambah Lapisan">+</button>
                <button id="delete-layer-btn" class="layer-control-btn" title="Padam Lapisan">-</button>                
            </div>
            <div class="tool-group">
                 <label>Sejarah:</label>
            </div>
            <div class="tool-group quick-tool">
                <button id="undo-btn" class="tool-btn" title="Undo"></button>
                <button id="redo-btn" class="tool-btn" title="Redo"></button>
            </div>
             <div class="tool-group">
                <button id="clear-btn">Clear</button>
            </div>
        </div>
        <button id="toolbar-toggle">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="18 15 12 9 6 15"></polyline></svg>
        </button>
    </div>
    <div id="main-content">
        <div id="canvas-container">
            <div id="canvas-wrapper">
                <canvas id="preview-canvas"></canvas>
            </div>
            <div id="custom-cursor"></div>
        </div>
    </div>

    <!-- Dialog Boxes -->
    <div id="startup-dialog-overlay" class="dialog-overlay">
        <div id="startup-box" class="dialog-box">
            <h2 class="dialog-message">Selamat Datang ke Lukisan Kreatif!</h2>
            <p>Mulakan projek baru atau buka kerja anda yang sedia ada.</p>
            <div id="new-project-options">
                <button id="create-new-btn" class="dialog-btn startup-btn">Cipta Projek Baru</button>
                <button id="load-existing-btn" class="dialog-btn startup-btn">Buka Projek (.jan)</button>
            </div>
        </div>
    </div>
    <div id="new-project-dialog-overlay" class="dialog-overlay" style="display: none;">
        <div id="new-project-box" class="dialog-box">
            <h2 class="dialog-message">Cipta Projek Baru</h2>
            <p>Pilih jenis latar belakang:</p>
             <div id="new-project-options">
                <button id="create-white-bg-btn" class="dialog-btn startup-btn">Putih</button>
                <button id="create-trans-bg-btn" class="dialog-btn startup-btn">Lutsinar</button>
            </div>
        </div>
    </div>
    <div id="confirm-dialog-overlay" class="dialog-overlay" style="display: none;">
        <div id="confirm-box" class="dialog-box">
            <p id="confirm-message" class="dialog-message"></p>
            <div>
                <button id="confirm-yes" class="dialog-btn">Ya</button>
                <button id="confirm-no" class="dialog-btn">Tidak</button>
            </div>
        </div>
    </div>
    <div id="prompt-dialog-overlay" class="dialog-overlay" style="display: none;">
        <div id="prompt-box" class="dialog-box">
            <p id="prompt-message" class="dialog-message"></p>
            <input type="text" id="prompt-input">
            <div>
                <button id="prompt-save" class="dialog-btn">Simpan</button>
                <button id="prompt-cancel" class="dialog-btn">Batal</button>
            </div>
        </div>
    </div>
    <input type="file" id="bg-image-input" accept="image/*" style="display: none;">
    <input type="file" id="project-input" accept=".jan" style="display: none;">

    <script>
        class CustomPrompt {
            constructor() {
                this.overlay = document.getElementById('prompt-dialog-overlay');
                this.messageEl = document.getElementById('prompt-message');
                this.inputEl = document.getElementById('prompt-input');
                this.saveBtn = document.getElementById('prompt-save');
                this.cancelBtn = document.getElementById('prompt-cancel');
            }
            show(message, defaultValue = '') {
                return new Promise((resolve) => {
                    this.messageEl.textContent = message;
                    this.inputEl.value = defaultValue;
                    this.overlay.style.display = 'flex';
                    this.inputEl.focus();
                    this.inputEl.select();
                    const saveHandler = () => { this.overlay.style.display = 'none'; cleanup(); resolve(this.inputEl.value.trim()); };
                    const cancelHandler = () => { this.overlay.style.display = 'none'; cleanup(); resolve(null); };
                    const keydownHandler = (e) => { if (e.key === 'Enter') { saveHandler(); } else if (e.key === 'Escape') { cancelHandler(); } };
                    const cleanup = () => { this.saveBtn.removeEventListener('click', saveHandler); this.cancelBtn.removeEventListener('click', cancelHandler); document.removeEventListener('keydown', keydownHandler); };
                    this.saveBtn.addEventListener('click', saveHandler);
                    this.cancelBtn.addEventListener('click', cancelHandler);
                    document.addEventListener('keydown', keydownHandler);
                });
            }
        }
        class CustomConfirm {
            constructor() { this.overlay = document.getElementById('confirm-dialog-overlay'); this.messageEl = document.getElementById('confirm-message'); this.yesBtn = document.getElementById('confirm-yes'); this.noBtn = document.getElementById('confirm-no'); } show(message) { return new Promise((resolve) => { this.messageEl.textContent = message; this.overlay.style.display = 'flex'; const yesHandler = () => { this.overlay.style.display = 'none'; resolve(true); this.yesBtn.removeEventListener('click', yesHandler); this.noBtn.removeEventListener('click', noHandler); }; const noHandler = () => { this.overlay.style.display = 'none'; resolve(false); this.yesBtn.removeEventListener('click', yesHandler); this.noBtn.removeEventListener('click', noHandler); }; this.yesBtn.addEventListener('click', yesHandler); this.noBtn.addEventListener('click', noHandler); }); } }
        
        class DrawingApp {
            constructor() {
                this.setupDOMReferences();
                this.initializeAppState();
                window.addEventListener('load', () => this.initApp());
            }

            setupDOMReferences() {
                this.canvasContainer = document.getElementById('canvas-container');
                this.canvasWrapper = document.getElementById('canvas-wrapper');
                this.previewCanvas = document.getElementById('preview-canvas');
                this.previewCtx = this.previewCanvas.getContext('2d');
                this.toolbarWrapper = document.getElementById('toolbar-wrapper');
                this.toolbar = document.getElementById('toolbar');
                this.customCursor = document.getElementById('custom-cursor');
                this.confirmDialog = new CustomConfirm();
                this.promptDialog = new CustomPrompt();
                this.sizeSlider = document.getElementById('size-slider');
                this.sizeDisplay = document.getElementById('size-display');
                this.opacitySlider = document.getElementById('opacity-slider');
                this.opacityDisplay = document.getElementById('opacity-display');
                this.colorPicker = document.getElementById('color-picker');
                this.prevColor1 = document.getElementById('prev-color-1');
                this.prevColor2 = document.getElementById('prev-color-2');
                this.undoBtn = document.getElementById('undo-btn');
                this.redoBtn = document.getElementById('redo-btn');
                this.layersDropdown = document.getElementById('layers-dropdown');
                this.addLayerBtn = document.getElementById('add-layer-btn');
                this.deleteLayerBtn = document.getElementById('delete-layer-btn');
                this.visibilityBtn = document.getElementById('visibility-btn');
                this.moveLayerUpBtn = document.getElementById('move-layer-up-btn');
                this.moveLayerDownBtn = document.getElementById('move-layer-down-btn');
                this.bgImageInput = document.getElementById('bg-image-input');
                this.projectInput = document.getElementById('project-input');
                this.brushTypeSelect = document.getElementById('brush-type-select');
            }
            initializeAppState() { 
                this.isDrawing = false; this.isPanning = false; this.middleClickPanning = false; 
                this.isPinching = false; this.touchStartTimer = null; this.brushSize = 15; 
                this.brushColor = '#000000'; this.brushOpacity = 1; this.currentTool = 'brush'; 
                this.currentBrushType = 'round'; this.lastPoint = { x: 0, y: 0 }; 
                this.startShapePoint = {x: 0, y: 0}; this.zoom = 1; 
                this.panOffset = { x: 0, y: 0 }; this.startPanPoint = { x: 0, y: 0 }; 
                this.initialPanOffset = { x: 0, y: 0 }; this.canvasSize = { width: 1920, height: 1080 }; 
                this.layers = []; this.activeLayerIndex = 0; this.layerCounter = 0; 
                this.lastTouchDistance = null; this.lastTouchMidpoint = null;
                this.projectBackground = 'white';
                this.previousColors = ['#FFFFFF', '#FFFFFF'];
            }
            initApp() {
                this.setupEventListeners();
                this.showStartupDialog();
            }
            
            showStartupDialog() {
                document.getElementById('startup-dialog-overlay').style.display = 'flex';
                document.getElementById('create-new-btn').onclick = () => {
                    document.getElementById('startup-dialog-overlay').style.display = 'none';
                    this.showNewProjectDialog();
                };
                document.getElementById('load-existing-btn').onclick = () => {
                     document.getElementById('startup-dialog-overlay').style.display = 'none';
                     this.projectInput.click();
                };
            }

            showNewProjectDialog() {
                const dialog = document.getElementById('new-project-dialog-overlay');
                dialog.style.display = 'flex';
                document.getElementById('create-white-bg-btn').onclick = () => {
                    dialog.style.display = 'none';
                    this.createNewWorkspace('white');
                };
                document.getElementById('create-trans-bg-btn').onclick = () => {
                    dialog.style.display = 'none';
                    this.createNewWorkspace('transparent');
                };
            }

            createNewWorkspace(backgroundType) {
                this.projectBackground = backgroundType;
                if (backgroundType === 'transparent') {
                    this.canvasWrapper.classList.add('checkerboard-bg');
                    this.canvasWrapper.style.backgroundColor = 'transparent';
                } else {
                    this.canvasWrapper.classList.remove('checkerboard-bg');
                    this.canvasWrapper.style.backgroundColor = 'white';
                }
                this.setupCanvasWrapperSize();
                this.addLayer();
                this.centerCanvas();
                this.updateCursor();
                document.getElementById('toolbar-wrapper').style.visibility = 'visible';
                window.addEventListener('resize', () => this.resizeAllCanvases());
            }
            
            setupEventListeners() {
                 this.previewCanvas.addEventListener('mousedown', (e) => { if (e.button === 1) { e.preventDefault(); this.middleClickPanning = true; this.isPanning = true; const mousePos = this.getMousePosInContainer(e); this.startPanPoint = { x: mousePos.x, y: mousePos.y }; this.initialPanOffset = { x: this.panOffset.x, y: this.panOffset.y }; this.canvasContainer.classList.add('panning'); } });
                window.addEventListener('mouseup', (e) => { if (e.button === 1 && this.middleClickPanning) { e.preventDefault(); this.isPanning = false; this.middleClickPanning = false; this.canvasContainer.classList.remove('panning'); } });
                this.previewCanvas.addEventListener('mousedown', (e) => this.startAction(e));
                this.previewCanvas.addEventListener('mousemove', (e) => this.moveAction(e));
                this.previewCanvas.addEventListener('mouseup', (e) => this.endAction(e));
                this.previewCanvas.addEventListener('mouseleave', (e) => this.endAction(e));
                this.canvasContainer.addEventListener('wheel', (e) => this.handleZoom(e), { passive: false });
                this.previewCanvas.addEventListener('mouseenter', () => { if(this.currentTool !== 'pan') this.customCursor.style.display = 'block'; });
                this.previewCanvas.addEventListener('mouseleave', () => { this.customCursor.style.display = 'none'; });
                this.previewCanvas.addEventListener('touchstart', (e) => this.handleTouchStart(e), { passive: false });
                this.previewCanvas.addEventListener('touchmove', (e) => this.handleTouchMove(e), { passive: false });
                this.previewCanvas.addEventListener('touchend', (e) => this.handleTouchEnd(e));
                this.toolbar.addEventListener('click', (e) => this.handleToolbarClick(e));
                
                this.colorPicker.addEventListener('change', (e) => this.setBrushColor(e.target.value, true));

                this.prevColor1.addEventListener('click', () => {
                    const swatchColor = this.previousColors[0];
                    if (!swatchColor || swatchColor.toUpperCase() === this.brushColor.toUpperCase()) return;
                    const mainColor = this.brushColor;

                    this.brushColor = swatchColor;
                    this.colorPicker.value = swatchColor;
                    this.previousColors[0] = mainColor;
                    this.prevColor1.style.backgroundColor = mainColor;
                });

                this.prevColor2.addEventListener('click', () => {
                    const swatchColor = this.previousColors[1];
                    if (!swatchColor || swatchColor.toUpperCase() === this.brushColor.toUpperCase()) return;
                    const mainColor = this.brushColor;

                    this.brushColor = swatchColor;
                    this.colorPicker.value = swatchColor;
                    this.previousColors[1] = mainColor;
                    this.prevColor2.style.backgroundColor = mainColor;
                });

                document.getElementById('toolbar-toggle').addEventListener('click', () => { this.toolbarWrapper.classList.toggle('hidden'); });
                this.brushTypeSelect.addEventListener('change', (e) => { this.currentBrushType = e.target.value; });
                this.addLayerBtn.addEventListener('click', () => this.addLayer());
                this.deleteLayerBtn.addEventListener('click', () => this.deleteLayer());
                this.layersDropdown.addEventListener('change', (e) => this.setActiveLayer(parseInt(e.target.value)));
                this.visibilityBtn.addEventListener('click', () => this.toggleVisibility());
                this.moveLayerUpBtn.addEventListener('click', () => this.moveLayer('up'));
                this.moveLayerDownBtn.addEventListener('click', () => this.moveLayer('down'));
                document.getElementById('open-bg-image-btn').addEventListener('click', () => this.bgImageInput.click());
                this.bgImageInput.addEventListener('change', (e) => this.loadBackgroundImage(e));
                document.getElementById('save-project-btn').addEventListener('click', () => this.saveProject());
                
                document.getElementById('open-project-btn').addEventListener('click', async () => {
                    const confirmed = await this.confirmDialog.show('Membuka projek baru akan memadamkan kerja semasa anda. Teruskan?');
                    if (confirmed) {
                        this.resetWorkspace();
                        this.toolbarWrapper.style.visibility = 'hidden';
                        this.showStartupDialog();
                    }
                });

                this.projectInput.addEventListener('change', (e) => this.loadProject(e));
                this.sizeSlider.addEventListener('input', (e) => this.setBrushSize(e.target.value));
                this.opacitySlider.addEventListener('input', (e) => { this.brushOpacity = e.target.value; this.opacityDisplay.textContent = `${Math.round(e.target.value * 100)}%`; });
            }
            
            handleTouchStart(e) { e.preventDefault(); clearTimeout(this.touchStartTimer); const touches = e.touches; if (touches.length === 1) { const touch = touches[0]; this.touchStartTimer = setTimeout(() => { this.startAction({ clientX: touch.clientX, clientY: touch.clientY }); }, 50); } else if (touches.length >= 2) { clearTimeout(this.touchStartTimer); this.isDrawing = false; this.isPinching = true; this.lastTouchDistance = this.getTouchDistance(touches); this.lastTouchMidpoint = this.getTouchMidpoint(touches); } }
            handleTouchMove(e) { e.preventDefault(); const touches = e.touches; if (touches.length === 1 && !this.isPinching) { clearTimeout(this.touchStartTimer); if (!this.isDrawing) { const touch = touches[0]; this.startAction({ clientX: touch.clientX, clientY: touch.clientY }); } this.moveAction({ clientX: touches[0].clientX, clientY: touches[0].clientY }); } else if (touches.length >= 2 && this.isPinching) { const newDist = this.getTouchDistance(touches); const newMidpoint = this.getTouchMidpoint(touches); if (this.lastTouchDistance) { const zoomMultiplier = newDist / this.lastTouchDistance; this.zoomAtCenter(zoomMultiplier, { clientX: newMidpoint.x, clientY: newMidpoint.y }); } if (this.lastTouchMidpoint) { const dx = newMidpoint.x - this.lastTouchMidpoint.x; const dy = newMidpoint.y - this.lastTouchMidpoint.y; this.panOffset.x += dx; this.panOffset.y += dy; this.updateTransform(); } this.lastTouchDistance = newDist; this.lastTouchMidpoint = newMidpoint; } }
            handleTouchEnd(e) { clearTimeout(this.touchStartTimer); if (this.isDrawing) { this.endAction(e); } this.isPinching = false; this.isDrawing = false; this.isPanning = false; this.lastTouchDistance = null; this.lastTouchMidpoint = null; }
            getTouchDistance(touches) { const dx = touches[0].clientX - touches[1].clientX; const dy = touches[0].clientY - touches[1].clientY; return Math.hypot(dx, dy); }
            getTouchMidpoint(touches) { const x = (touches[0].clientX + touches[1].clientX) / 2; const y = (touches[0].clientY + touches[1].clientY) / 2; return { x, y }; }
            prepareContext(ctx) {
                ctx.lineWidth = this.brushSize / this.zoom;
                ctx.strokeStyle = this.brushColor;
                ctx.fillStyle = this.brushColor;
                ctx.globalAlpha = this.brushOpacity;
                ctx.globalCompositeOperation = this.currentTool === 'eraser' ? 'destination-out' : 'source-over';
                if (this.currentBrushType === 'square') {
                    ctx.lineCap = 'square';
                    ctx.lineJoin = 'miter';
                } else { 
                    ctx.lineCap = 'round';
                    ctx.lineJoin = 'round';
                }
            }
            startAction(e) {
                if (e.button === 1) return;
                if (this.currentTool === 'pan') {
                    this.isPanning = true;
                    const mousePos = this.getMousePosInContainer(e);
                    this.startPanPoint = { x: mousePos.x, y: mousePos.y };
                    this.initialPanOffset = { x: this.panOffset.x, y: this.panOffset.y };
                    this.canvasContainer.classList.add('panning');
                } else {
                    const layer = this.getActiveLayer();
                    if (!layer || !layer.visible) return;
                    this.isDrawing = true;
                    const canvasPos = this.getCanvasPosFromEvent(e);
                    if (this.currentTool === 'bucket') {
                        this.floodFill(Math.round(canvasPos.x), Math.round(canvasPos.y));
                        this.saveState();
                        this.isDrawing = false; // Stop drawing after one fill
                        return;
                    }
                    this.startShapePoint = canvasPos;
                    this.lastPoint = canvasPos;
                    this.prepareContext(layer.ctx);
                    if (this.currentTool === 'brush' || this.currentTool === 'eraser') {
                         const scaledBrushSize = this.brushSize / this.zoom;
                        switch (this.currentBrushType) {
                            case 'spray': this.drawSpray(layer.ctx, canvasPos); break;
                            case 'square': layer.ctx.fillRect(canvasPos.x - scaledBrushSize / 2, canvasPos.y - scaledBrushSize / 2, scaledBrushSize, scaledBrushSize); break;
                            case 'round': layer.ctx.beginPath(); layer.ctx.arc(canvasPos.x, canvasPos.y, scaledBrushSize / 2, 0, 2 * Math.PI); layer.ctx.fill(); break;
                        }
                        layer.ctx.beginPath();
                        layer.ctx.moveTo(canvasPos.x, canvasPos.y);
                    }
                }
            }
            moveAction(e) {
                const mousePosContainer = this.getMousePosInContainer(e);
                this.updateCursorPosition(mousePosContainer);

                if (this.isPanning) {
                    const dx = mousePosContainer.x - this.startPanPoint.x;
                    const dy = mousePosContainer.y - this.startPanPoint.y;
                    this.panOffset.x = this.initialPanOffset.x + dx;
                    this.panOffset.y = this.initialPanOffset.y + dy;
                    this.updateTransform();
                } else if (this.isDrawing) {
                    const canvasPos = this.getCanvasPosFromEvent(e);
                    const layer = this.getActiveLayer();
                    if (!layer) return;

                    if (this.currentTool === 'brush' || this.currentTool === 'eraser') {
                        switch (this.currentBrushType) {
                            case 'round':
                            case 'square':
                                layer.ctx.lineTo(canvasPos.x, canvasPos.y);
                                layer.ctx.stroke();
                                layer.ctx.beginPath();
                                layer.ctx.moveTo(canvasPos.x, canvasPos.y);
                                break;
                            case 'spray': this.drawSpray(layer.ctx, canvasPos); break;
                        }
                    } else {
                        this.previewCtx.clearRect(0, 0, this.previewCanvas.width, this.previewCanvas.height);
                        this.prepareContext(this.previewCtx);
                        this.drawShape(this.previewCtx, this.startShapePoint, canvasPos, this.currentTool);
                    }
                }
            }
            endAction(e) {
                if (e.button === 1) return;
                if (this.isDrawing) {
                    const layer = this.getActiveLayer();
                    if (layer) {
                        const canvasPos = this.getCanvasPosFromEvent(e); 
                        if (['line', 'rectangle', 'circle'].includes(this.currentTool)) {
                            this.previewCtx.clearRect(0, 0, this.previewCanvas.width, this.previewCanvas.height);
                            this.prepareContext(layer.ctx);
                            this.drawShape(layer.ctx, this.startShapePoint, canvasPos, this.currentTool);
                        }
                        layer.ctx.closePath();
                        this.saveState();
                    }
                }
                this.isDrawing = false;
                this.isPanning = false;
                this.canvasContainer.classList.remove('panning');
            }
            floodFill(startX, startY) {
                const layer = this.getActiveLayer();
                if (!layer) return;
                const ctx = layer.ctx;
                const canvasWidth = layer.canvas.width;
                const canvasHeight = layer.canvas.height;
                const imageData = ctx.getImageData(0, 0, canvasWidth, canvasHeight);
                const data = imageData.data;
                const getPixelIndex = (x, y) => (y * canvasWidth + x) * 4;
                const targetColorIndex = getPixelIndex(startX, startY);
                const targetColor = [ data[targetColorIndex], data[targetColorIndex + 1], data[targetColorIndex + 2], data[targetColorIndex + 3] ];
                const hexToRgba = (hex) => { const r = parseInt(hex.slice(1, 3), 16); const g = parseInt(hex.slice(3, 5), 16); const b = parseInt(hex.slice(5, 7), 16); return [r, g, b, Math.round(this.brushOpacity * 255)]; };
                const fillColor = hexToRgba(this.brushColor);
                if (targetColor.every((v, i) => v === fillColor[i])) return;
                
                const pixelsToCheck = [startX, startY];
                while (pixelsToCheck.length > 0) {
                    const y = pixelsToCheck.pop();
                    const x = pixelsToCheck.pop();
                    const currentIndex = getPixelIndex(x, y);
                    if (x < 0 || x >= canvasWidth || y < 0 || y >= canvasHeight) continue;
                    if (data[currentIndex] === targetColor[0] && data[currentIndex + 1] === targetColor[1] && data[currentIndex + 2] === targetColor[2] && data[currentIndex + 3] === targetColor[3]) {
                        data[currentIndex] = fillColor[0];
                        data[currentIndex + 1] = fillColor[1];
                        data[currentIndex + 2] = fillColor[2];
                        data[currentIndex + 3] = fillColor[3];
                        pixelsToCheck.push(x + 1, y);
                        pixelsToCheck.push(x - 1, y);
                        pixelsToCheck.push(x, y + 1);
                        pixelsToCheck.push(x, y - 1);
                    }
                }
                ctx.putImageData(imageData, 0, 0);
            }
            addLayer(data = null) { this.layerCounter++; const layerId = this.layers.length; const canvas = document.createElement('canvas'); canvas.className = 'canvas-layer'; canvas.width = this.canvasSize.width; canvas.height = this.canvasSize.height; const ctx = canvas.getContext('2d'); this.canvasWrapper.insertBefore(canvas, this.previewCanvas); const layer = { id: layerId, name: data ? data.name : `Lapisan ${this.layerCounter}`, canvas: canvas, ctx: ctx, history: [], historyIndex: -1, visible: data ? data.visible : true }; this.layers.push(layer); this.setActiveLayer(layer.id); if (data && data.imageDataURL) { const img = new Image(); img.onload = () => { layer.ctx.drawImage(img, 0, 0); this.saveState(); }; img.src = data.imageDataURL; } else { this.saveState(); } if (data && !data.visible) { layer.canvas.style.display = 'none'; } this.renderLayersList(); return layer; }
            async deleteLayer() { if (this.layers.length <= 1) return; const confirmed = await this.confirmDialog.show('Anda pasti mahu memadam lapisan ini?'); if (confirmed) { const layerToRemoveIndex = this.layers.findIndex(l => l.id === this.activeLayerIndex); if(layerToRemoveIndex === -1) return; this.layers[layerToRemoveIndex].canvas.remove(); this.layers.splice(layerToRemoveIndex, 1); this.setActiveLayer(this.layers[this.layers.length - 1].id); } }
            setActiveLayer(id) { this.activeLayerIndex = id; this.renderLayersList(); this.updateHistoryButtons(); }
            toggleVisibility() { const layer = this.getActiveLayer(); if (!layer) return; layer.visible = !layer.visible; layer.canvas.style.display = layer.visible ? 'block' : 'none'; this.renderLayersList(); }
            moveLayer(direction) {
                const currentIndex = this.layers.findIndex(l => l.id === this.activeLayerIndex);
                if (currentIndex === -1) return;

                if (direction === 'up' && currentIndex < this.layers.length - 1) {
                    [this.layers[currentIndex], this.layers[currentIndex + 1]] = [this.layers[currentIndex + 1], this.layers[currentIndex]];
                } else if (direction === 'down' && currentIndex > 0) {
                    [this.layers[currentIndex], this.layers[currentIndex - 1]] = [this.layers[currentIndex - 1], this.layers[currentIndex]];
                }
                this.renderCanvasOrder();
                this.renderLayersList();
            }
            renderCanvasOrder() {
                const allCanvases = [...this.canvasWrapper.querySelectorAll('.canvas-layer')];
                allCanvases.forEach(c => c.remove());
                this.layers.forEach(layer => {
                    this.canvasWrapper.insertBefore(layer.canvas, this.previewCanvas);
                });
            }
            renderLayersList() { this.layersDropdown.innerHTML = ''; [...this.layers].reverse().forEach(layer => { const option = document.createElement('option'); option.value = layer.id; option.textContent = layer.name; if (!layer.visible) { option.classList.add('hidden-layer'); } this.layersDropdown.appendChild(option); }); this.layersDropdown.value = this.activeLayerIndex; const activeLayer = this.getActiveLayer(); const currentIndex = this.layers.findIndex(l => l.id === this.activeLayerIndex); if (activeLayer) { this.visibilityBtn.innerHTML = activeLayer.visible ? 'üëÅÔ∏è' : '‚ûñ'; this.deleteLayerBtn.disabled = this.layers.length <= 1; this.moveLayerUpBtn.disabled = currentIndex >= this.layers.length - 1; this.moveLayerDownBtn.disabled = currentIndex <= 0; } }
            getActiveLayer() { return this.layers.find(l => l.id === this.activeLayerIndex); }
            setupCanvasWrapperSize() { this.canvasWrapper.style.width = `${this.canvasSize.width}px`; this.canvasWrapper.style.height = `${this.canvasSize.height}px`; this.previewCanvas.width = this.canvasSize.width; this.previewCanvas.height = this.canvasSize.height; }
            resizeAllCanvases() { this.updateTransform(); }
            drawSpray(ctx, pos) { const density = this.brushSize * 0.5; for (let i = 0; i < density; i++) { const angle = Math.random() * 2 * Math.PI; const radius = Math.random() * (this.brushSize / 2 / this.zoom); const offsetX = Math.cos(angle) * radius; const offsetY = Math.sin(angle) * radius; ctx.fillRect(pos.x + offsetX, pos.y + offsetY, 1, 1); } }
            drawShape(ctx, start, end, tool) { ctx.beginPath(); switch(tool) { case 'line': ctx.moveTo(start.x, start.y); ctx.lineTo(end.x, end.y); break; case 'rectangle': ctx.rect(start.x, start.y, end.x - start.x, end.y - start.y); break; case 'circle': const dx = end.x - start.x; const dy = end.y - start.y; const radius = Math.sqrt(dx * dx + dy * dy); ctx.arc(start.x, start.y, radius, 0, 2 * Math.PI); break; } ctx.stroke(); }
            saveState() { const layer = this.getActiveLayer(); if (!layer) return; layer.history = layer.history.slice(0, layer.historyIndex + 1); layer.history.push(layer.ctx.getImageData(0, 0, this.canvasSize.width, this.canvasSize.height)); layer.historyIndex++; this.updateHistoryButtons(); }
            handleZoom(e) { e.preventDefault(); const zoomIntensity = 0.1; const wheel = e.deltaY < 0 ? 1 : -1; const zoomMultiplier = Math.exp(wheel * zoomIntensity); this.zoomAtCenter(zoomMultiplier, e); }
            centerCanvas() { const cRect = this.canvasContainer.getBoundingClientRect(); this.zoom = Math.min(cRect.width / this.canvasSize.width, cRect.height / this.canvasSize.height) * 0.9; this.panOffset.x = (cRect.width - this.canvasSize.width * this.zoom) / 2; this.panOffset.y = (cRect.height - this.canvasSize.height * this.zoom) / 2; this.updateTransform(); }
            updateTransform() { this.canvasWrapper.style.transform = `translate(${this.panOffset.x}px, ${this.panOffset.y}px) scale(${this.zoom})`; const cursorSize = this.brushSize; this.customCursor.style.width = `${cursorSize}px`; this.customCursor.style.height = `${cursorSize}px`; }
            updateCursorPosition(pos) { this.customCursor.style.left = `${pos.x}px`; this.customCursor.style.top = `${pos.y}px`; }
            getEventCoordinates(e) { if (e.touches && e.touches.length > 0) { return { clientX: e.touches[0].clientX, clientY: e.touches[0].clientY }; } if (e.changedTouches && e.changedTouches.length > 0) { return { clientX: e.changedTouches[0].clientX, clientY: e.changedTouches[0].clientY }; } return { clientX: e.clientX, clientY: e.clientY }; }
            getCanvasPosFromEvent(e) { const rect = this.previewCanvas.getBoundingClientRect(); const { clientX, clientY } = this.getEventCoordinates(e); return { x: (clientX - rect.left) / this.zoom, y: (clientY - rect.top) / this.zoom }; }
            getMousePosInContainer(e) { const rect = this.canvasContainer.getBoundingClientRect(); const { clientX, clientY } = this.getEventCoordinates(e); return { x: clientX - rect.left, y: clientY - rect.top }; }
            handleToolbarClick(e) { const target = e.target.closest('button'); if (!target) return; if (target.dataset.tool) { this.setActiveButton(target, '.tool-btn[data-tool]'); this.currentTool = target.dataset.tool; this.updateCursor(); } if (target.dataset.size) { this.setBrushSize(target.dataset.size); this.setActiveButton(target, '.size-preset-btn');} if (target.id === 'undo-btn') this.undo(); if (target.id === 'redo-btn') this.redo(); if (target.id === 'save-png-btn') this.saveAsPng(); if (target.id === 'clear-btn') this.clearCanvas(); }
            
            setBrushColor(color, updateHistory = true) {
                const upperCaseColor = color.toUpperCase();
                if (!color || upperCaseColor === this.brushColor.toUpperCase()) return;

                const oldColor = this.brushColor;
                
                this.brushColor = upperCaseColor;
                this.colorPicker.value = this.brushColor;
                
                if (updateHistory) {
                    this.updatePreviousColors(oldColor);
                }
            }

            updatePreviousColors(oldColor) {
                if (oldColor.toUpperCase() === this.previousColors[0].toUpperCase() || oldColor.toUpperCase() === this.previousColors[1].toUpperCase()) return;
                
                this.previousColors.unshift(oldColor);
                this.previousColors.pop();

                this.prevColor1.style.backgroundColor = this.previousColors[0];
                this.prevColor2.style.backgroundColor = this.previousColors[1];
            }

            setBrushSize(size) { this.brushSize = size; this.sizeSlider.value = size; this.sizeDisplay.textContent = size; this.updateTransform(); }
            
            async saveAsPng() {
                const defaultName = `lukisan-${new Date().toISOString().slice(0,10)}`;
                const filename = await this.promptDialog.show("Simpan sebagai PNG:", defaultName);
                if (!filename) {
                    console.log("Simpanan PNG dibatalkan.");
                    return;
                }

                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = this.canvasSize.width;
                tempCanvas.height = this.canvasSize.height;
                const tempCtx = tempCanvas.getContext('2d');

                if (this.projectBackground === 'white') {
                    tempCtx.fillStyle = 'white';
                    tempCtx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
                }

                this.layers.forEach(layer => {
                    if (layer.visible && layer.canvas) {
                        try {
                            tempCtx.drawImage(layer.canvas, 0, 0);
                        } catch (error) {
                            console.error(`Gagal melukis lapisan "${layer.name}" ke PNG:`, error);
                        }
                    }
                });

                const link = document.createElement('a');
                link.download = `${filename.replace(/\.png$/i, '')}.png`;
                link.href = tempCanvas.toDataURL('image/png');
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }

            async saveProject() { const defaultName = `projek-${Date.now()}`; const filename = await this.promptDialog.show("Simpan sebagai Projek Jan:", defaultName); if (!filename) return; const projectData = { canvasSize: this.canvasSize, background: this.projectBackground, layers: this.layers.map(layer => ({ name: layer.name, visible: layer.visible, imageDataURL: layer.canvas.toDataURL() })) }; const jsonString = JSON.stringify(projectData); const blob = new Blob([jsonString], {type: 'application/json'}); const link = document.createElement('a'); link.href = URL.createObjectURL(blob); link.download = `${filename.replace(/\.jan$/i, '')}.jan`; link.click(); }
            async clearCanvas() { const confirmed = await this.confirmDialog.show('Anda pasti mahu mengosongkan kandungan lapisan ini?'); if (confirmed) { const layer = this.getActiveLayer(); if (layer) { layer.ctx.clearRect(0, 0, this.canvasSize.width, this.canvasSize.height); this.saveState(); } } }
            undo() { const layer = this.getActiveLayer(); if (layer && layer.historyIndex > 0) { layer.historyIndex--; layer.ctx.putImageData(layer.history[layer.historyIndex], 0, 0); this.updateHistoryButtons(); } }
            redo() { const layer = this.getActiveLayer(); if (layer && layer.historyIndex < layer.history.length - 1) { layer.historyIndex++; layer.ctx.putImageData(layer.history[layer.historyIndex], 0, 0); this.updateHistoryButtons(); } }
            updateHistoryButtons() { const layer = this.getActiveLayer(); this.undoBtn.disabled = !layer || layer.historyIndex <= 0; this.redoBtn.disabled = !layer || layer.historyIndex >= layer.history.length - 1; }
            zoomAtCenter(zoomMultiplier, event = null) { const containerRect = this.canvasContainer.getBoundingClientRect(); const center = event ? this.getMousePosInContainer(event) : { x: containerRect.width / 2, y: containerRect.height / 2 }; this.panOffset.x = center.x - (center.x - this.panOffset.x) * zoomMultiplier; this.panOffset.y = center.y - (center.y - this.panOffset.y) * zoomMultiplier; this.zoom *= zoomMultiplier; this.updateTransform(); }
            updateCursor() { if (this.currentTool === 'pan' || this.middleClickPanning) { this.canvasContainer.style.cursor = 'grab'; this.customCursor.style.display = 'none'; } else { this.canvasContainer.style.cursor = 'none'; } this.updateTransform(); }
            setActiveButton(button, selector) { this.toolbar.querySelectorAll(selector).forEach(btn => btn.classList.remove('active')); button.classList.add('active'); }
            async loadBackgroundImage(event) { const file = event.target.files[0]; if (!file) return; const confirmed = await this.confirmDialog.show('Ini akan menggantikan kandungan pada lapisan paling bawah (Lapisan 1). Teruskan?'); if (!confirmed) { this.bgImageInput.value = ''; return; } const reader = new FileReader(); reader.onload = (e) => { const img = new Image(); img.onload = () => { const baseLayer = this.layers[0]; if (baseLayer) { const currentOpacity = baseLayer.ctx.globalAlpha; baseLayer.ctx.globalAlpha = 1.0; baseLayer.ctx.clearRect(0, 0, baseLayer.canvas.width, baseLayer.canvas.height); baseLayer.ctx.drawImage(img, 0, 0, baseLayer.canvas.width, baseLayer.canvas.height); baseLayer.ctx.globalAlpha = currentOpacity; const originalActiveLayerId = this.activeLayerIndex; this.activeLayerIndex = baseLayer.id; this.saveState(); this.setActiveLayer(originalActiveLayerId); } }; img.src = e.target.result; }; reader.readAsDataURL(file); this.bgImageInput.value = ''; }
            async loadProject(event) {
                const file = (event && event.target) ? event.target.files[0] : null;
                if (!file) {
                    this.showStartupDialog();
                    return;
                }
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const projectData = JSON.parse(e.target.result);
                        this.resetWorkspace();
                        this.createNewWorkspace(projectData.background || 'white');
                        this.layers[0].canvas.remove();
                        this.layers = [];
                        this.layerCounter = 0;
                        this.canvasSize = projectData.canvasSize;
                        this.setupCanvasWrapperSize();
                        projectData.layers.forEach(layerData => this.addLayer(layerData));
                        this.resetUIToDefaults();
                    } catch (err) {
                        alert('Gagal membuka fail projek. Fail mungkin rosak.');
                        console.error("Error parsing project file:", err);
                        this.showStartupDialog();
                    }
                };
                reader.readAsText(file);
                if (this.projectInput) this.projectInput.value = '';
            }
            resetWorkspace() {
                this.layers.forEach(layer => layer.canvas.remove());
                this.initializeAppState();
                this.resetUIToDefaults();
                this.canvasWrapper.classList.remove('checkerboard-bg');
                this.canvasWrapper.style.backgroundColor = 'white';
             }
            resetUIToDefaults() {
                this.setBrushColor('#000000', false);
                this.colorPicker.value = '#000000'; // FIX: Set UI value explicitly on reset
                this.setBrushSize(15);
                this.opacitySlider.value = 1;
                this.opacityDisplay.textContent = '100%';
                this.brushOpacity = 1;
                this.previousColors = ['#FFFFFF', '#FFFFFF'];
                this.prevColor1.style.backgroundColor = this.previousColors[0];
                this.prevColor2.style.backgroundColor = this.previousColors[1];
                this.currentTool = 'brush';
                this.setActiveButton(document.getElementById('brush-btn'), '.tool-btn[data-tool]');
                this.setActiveButton(document.querySelector('.size-preset-btn[data-size="15"]'), '.size-preset-btn');
                this.brushTypeSelect.value = 'round';
                this.currentBrushType = 'round';
            }
        }
        
        new DrawingApp();
    </script>
</body>
</html>


