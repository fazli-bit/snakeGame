<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Lukisan Kreatif: Versi Akhir (Lengkap Sepenuhnya)</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&display=swap');

        :root {
            --bg-color: #f0f2f5;
            --toolbar-bg: #ffffff;
            --toolbar-secondary-bg: #f8f9fa;
            --canvas-bg: #ffffff;
            --primary-color: #0d6efd;
            --text-color: #212529;
            --icon-color: #495057;
            --border-color: #dee2e6;
            --shadow-color: rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: 'Nunito', sans-serif;
            display: flex;
            flex-direction: column;
            height: 100vh;
            margin: 0;
            background-color: var(--bg-color);
            overflow: hidden;
            color: var(--text-color);
        }

        #app-container {
            display: flex;
            flex-direction: column;
            width: 100%;
            height: 100%;
        }
        
        #toolbar-container {
            width: 100%;
            background-color: var(--toolbar-bg);
            box-shadow: 0 2px 5px var(--shadow-color);
            z-index: 1000;
            user-select: none;
        }

        #primary-toolbar {
            display: flex;
            justify-content: center;
            align-items: stretch;
            border-bottom: 1px solid var(--border-color);
            padding: 0 10px;
            position: relative;
        }

        .primary-tool-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: none;
            border: none;
            cursor: pointer;
            padding: 12px 16px;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--icon-color);
            border-bottom: 3px solid transparent;
            transition: all 0.2s ease-in-out;
        }

        .primary-tool-btn svg {
            width: 22px;
            height: 22px;
            margin-bottom: 4px;
        }

        .primary-tool-btn:hover {
            background-color: var(--bg-color);
        }

        .primary-tool-btn.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }
        
        #toggle-secondary-toolbar {
            margin-left: auto;
            padding: 12px;
            border-bottom: 3px solid transparent;
        }
        #toggle-secondary-toolbar svg {
            transition: transform 0.3s ease;
        }

        #secondary-toolbar-container {
            background-color: var(--toolbar-secondary-bg);
            overflow: hidden;
            max-height: 200px;
            padding: 10px;
            transition: max-height 0.4s ease, padding 0.4s ease;
        }
        
        #toolbar-container.secondary-hidden #secondary-toolbar-container {
            max-height: 0;
            padding-top: 0;
            padding-bottom: 0;
        }
        
        #toolbar-container.secondary-hidden #toggle-secondary-toolbar svg {
             transform: rotate(180deg);
        }

        .secondary-toolbar {
            display: none;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
            justify-content: center;
        }
        
        .tool-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .tool-group label {
            font-weight: 600;
            font-size: 0.8rem;
            white-space: nowrap;
        }

        .icon-btn, .size-preset-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background-color: #fff;
            border: 1px solid var(--border-color);
            cursor: pointer;
            color: var(--icon-color);
            transition: all 0.2s ease;
            font-weight: bold;
        }
        
        .icon-btn:hover, .size-preset-btn:hover {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        
        .icon-btn.active, .size-preset-btn.active {
             background-color: var(--primary-color);
             color: white;
             box-shadow: 0 0 8px rgba(13, 110, 253, 0.5);
        }
        .icon-btn:disabled, .size-preset-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background-color: #eee;
            color: #aaa;
        }

        .icon-btn svg { width: 18px; height: 18px; }
        input[type="range"] { width: 100px; }
        select { padding: 5px; border-radius: 6px; border: 1px solid var(--border-color); background-color: white; font-weight: 600; }
        
        main#canvas-area {
            flex-grow: 1;
            position: relative;
            overflow: hidden;
            background-color: var(--bg-color);
        }

        #canvas-container { 
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
        }
        #canvas-container.panning { cursor: grabbing; }
        #canvas-container.drawing { cursor: none; }

        #canvas-wrapper { 
            position: absolute; 
            box-shadow: 0 4px 15px var(--shadow-color);
            transform-origin: 0 0; 
        }
        .checkerboard-bg {
            background-image:
                linear-gradient(45deg, #ccc 25%, transparent 25%),
                linear-gradient(-45deg, #ccc 25%, transparent 25%),
                linear-gradient(45deg, transparent 75%, #ccc 75%),
                linear-gradient(-45deg, transparent 75%, #ccc 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
        }
        
        .canvas-layer, #preview-canvas { position: absolute; top: 0; left: 0; pointer-events: none; background-color: transparent; }
        #preview-canvas { pointer-events: auto; z-index: 100; }
        #custom-cursor { position: absolute; border: 1px solid #333; border-radius: 50%; pointer-events: none; transform: translate(-50%, -50%); display: none; z-index: 101;}

        #image-transform-overlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            z-index: 1050;
            display: none;
        }
        #transform-image-wrapper {
            position: absolute;
            border: 2px dashed var(--primary-color);
            cursor: move;
        }
        #transform-image {
            width: 100%;
            height: 100%;
            display: block;
        }
        .resize-handle {
            position: absolute;
            width: 12px;
            height: 12px;
            background-color: var(--primary-color);
            border: 2px solid white;
            border-radius: 50%;
        }
        .resize-handle.top-left { top: -8px; left: -8px; cursor: nwse-resize; }
        .resize-handle.top-right { top: -8px; right: -8px; cursor: nesw-resize; }
        .resize-handle.bottom-left { bottom: -8px; left: -8px; cursor: nesw-resize; }
        .resize-handle.bottom-right { bottom: -8px; right: -8px; cursor: nwse-resize; }
        #image-transform-controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.7);
            padding: 10px 15px;
            border-radius: 12px;
            display: flex;
            gap: 15px;
        }
        .transform-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 700;
            cursor: pointer;
        }
        .transform-btn.cancel {
            background: #6c757d;
        }


        #color-palette-container {
            background-color: var(--toolbar-bg);
            border-top: 1px solid var(--border-color);
            padding: 12px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 12px;
            flex-wrap: nowrap;
            overflow-x: auto;
            box-shadow: 0 -2px 5px var(--shadow-color);
        }
        
        #color-palette-container label {
            font-weight: 700;
            font-size: 0.85rem;
            white-space: nowrap;
        }

        .color-swatch {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 0 0 1px var(--border-color);
            cursor: pointer;
            transition: transform 0.2s;
            flex-shrink: 0;
        }
        .color-swatch:hover {
            transform: scale(1.1);
        }
        
        input[type="color"] {
            width: 38px;
            height: 38px;
            padding: 0;
            border: none;
            border-radius: 50%;
            overflow: hidden;
            cursor: pointer;
            flex-shrink: 0;
        }

        #theme-swatches {
            display: flex;
            gap: 10px;
        }
        .dialog-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); display: none; justify-content: center; align-items: center; z-index: 1200; animation: fade-in 0.3s ease; }
        .dialog-box { background-color: white; padding: 30px; border-radius: 12px; text-align: center; box-shadow: 0 8px 16px rgba(0,0,0,0.2); max-width: 400px; width: 90%; }
        .dialog-message { font-size: 1.2em; margin-bottom: 20px; }
        .dialog-btn { padding: 10px 20px; font-size: 1em; font-weight: 700; cursor: pointer; border: none; border-radius: 8px; color: white; margin: 0 10px; }
        #confirm-yes, #prompt-save, .startup-btn { background-color: var(--primary-color); }
        #confirm-no, #prompt-cancel { background-color: #75757d; }
        #new-project-options { margin-top: 20px; display: flex; justify-content: center; gap: 15px; }
        #new-project-options button { padding: 10px 15px; font-size: 1em; }
        #prompt-input { width: 100%; padding: 10px; box-sizing: border-box; border-radius: 8px; border: 1px solid #ccc; font-size: 1em; margin-bottom: 20px; }
        @keyframes fade-in { from { opacity: 0; } to { opacity: 1; } }

    </style>
</head>
<body>

    <div id="app-container">
        <header id="toolbar-container" style="visibility: hidden;">
            <nav id="primary-toolbar">
                <button class="primary-tool-btn active" data-target="#file-tools">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 22h14a2 2 0 0 0 2-2V7.5L14.5 2H6a2 2 0 0 0-2 2v4"/><polyline points="14 2 14 8 20 8"/><path d="M2 15h10"/><path d="m5 12-3 3 3 3"/></svg>
                    <span>Fail</span>
                </button>
                <button class="primary-tool-btn" data-target="#brush-tools">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m18 5-3-3-7.37 7.37a5.5 5.5 0 0 0-1.56 3.9V20a2 2 0 0 0 2 2h1.13a5.5 5.5 0 0 0 3.9-1.56Z"/><path d="m21 2-9.24 9.24"/><path d="m14.7 3.37 5.93 5.93"/></svg>
                    <span>Berus</span>
                </button>
                 <button class="primary-tool-btn" data-target="#color-tools">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 2a7 7 0 1 0 10 10"/></svg>
                    <span>Warna</span>
                </button>
                 <button class="primary-tool-btn" data-target="#layer-tools">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 2 7 12 12 22 7 12 2"/><polyline points="2 17 12 22 22 17"/><polyline points="2 12 12 17 22 12"/></svg>
                    <span>Lapisan</span>
                </button>
                <button id="toggle-secondary-toolbar" class="primary-tool-btn" title="Tunjuk/Sembunyi Alatan">
                     <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="18 15 12 9 6 15"></polyline></svg>
                </button>
            </nav>

            <div id="secondary-toolbar-container">
                <div id="file-tools" class="secondary-toolbar">
                    <div class="tool-group">
                        <button id="open-project-btn" class="icon-btn" title="Buka Projek"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m6 9 8-3.2A5.12 5.12 0 0 1 19 2V7h-1"/><path d="M19 12V5a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v14c0 1.1.9 2 2 2h14"/></svg></button>
                        <button id="save-project-btn" class="icon-btn" title="Simpan Projek"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg></button>
                        <button id="save-png-btn" class="icon-btn" title="Simpan sebagai PNG"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg></button>
                        <button id="open-bg-image-btn" class="icon-btn" title="Buka Imej Latar"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></svg></button>
                    </div>
                     <div class="tool-group">
                        <label>Sejarah:</label>
                        <button id="undo-btn" class="icon-btn" title="Buat Asal"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 7v6h6"/><path d="M21 17a9 9 0 0 0-9-10 9 9 0 0 0-6.36 2.64L3 7"/></svg></button>
                        <button id="redo-btn" class="icon-btn" title="Buat Semula"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 7v6h-6"/><path d="M3 17a9 9 0 0 0 9-10 9 9 0 0 0 6.36-2.64L21 7"/></svg></button>
                    </div>
                </div>

                <div id="brush-tools" class="secondary-toolbar">
                     <div class="tool-group">
                        <label>Alat:</label>
                        <button id="brush-btn" class="icon-btn" data-tool="brush" title="Berus"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m18 5-3-3-7.37 7.37a5.5 5.5 0 0 0-1.56 3.9V20a2 2 0 0 0 2 2h1.13a5.5 5.5 0 0 0 3.9-1.56Z"/></svg></button>
                        <button id="eraser-btn" class="icon-btn" data-tool="eraser" title="Pemadam"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m21 11-8-8-4.25 4.25 8 8Z"/><path d="M14 17.5 7.5 11l-5 5L9 22Z"/></svg></button>
                        <button id="bucket-btn" class="icon-btn" data-tool="bucket" title="Isian"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m8 2 2-2h4l2 2"/><path d="M12 6 7 4"/><path d="M22 14a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V7h10.5"/><path d="M6 7h2.2"/></svg></button>
                        <button id="pan-btn" class="icon-btn" data-tool="pan" title="Alih"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 15l-6-6-6 6"/><path d="M5 15V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v10Z"/></svg></button>
                    </div>
                    <div class="tool-group">
                         <label>Bentuk:</label>
                         <button id="line-tool-btn" class="icon-btn" data-tool="line" title="Garisan"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"/></svg></button>
                         <button id="rect-tool-btn" class="icon-btn" data-tool="rectangle" title="Segi Empat"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="3" rx="2"/></svg></button>
                         <button id="circle-tool-btn" class="icon-btn" data-tool="circle" title="Bulatan"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/></svg></button>
                    </div>
                    <div class="tool-group">
                        <label>Jenis:</label>
                        <select id="brush-type-select">
                            <option value="round">Bulat</option>
                            <option value="square">Segi Empat</option>
                            <option value="spray">Semburan</option>
                        </select>
                    </div>
                    <div class="tool-group">
                        <label>Saiz:</label>
                        <input type="range" id="size-slider" min="1" max="100" value="15">
                        <span id="size-display">15</span>
                        <button class="size-preset-btn icon-btn" data-size="5">S</button>
                        <button class="size-preset-btn icon-btn active" data-size="15">M</button>
                        <button class="size-preset-btn icon-btn" data-size="30">L</button>
                    </div>
                     <div class="tool-group">
                        <label>Lutsinar:</label>
                        <input type="range" id="opacity-slider" min="0" max="1" value="1" step="0.01">
                        <span id="opacity-display">100%</span>
                    </div>
                </div>
                
                <div id="color-tools" class="secondary-toolbar">
                     <div class="tool-group">
                        <label>Warna:</label>
                        <input type="color" id="color-picker" value="#0D6EFD">
                        <div id="prev-color-1" class="color-swatch" style="background-color: #6c757d;"></div>
                        <div id="prev-color-2" class="color-swatch" style="background-color: #198754;"></div>
                    </div>
                </div>
                
                <div id="layer-tools" class="secondary-toolbar">
                     <div class="tool-group">
                        <label>Lapisan:</label>
                        <select id="layers-dropdown"></select>
                    </div>
                    <div class="tool-group">
                         <button id="add-layer-btn" class="icon-btn" title="Tambah Lapisan"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg></button>
                         <button id="delete-layer-btn" class="icon-btn" title="Padam Lapisan"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"/></svg></button>
                         <button id="visibility-btn" class="icon-btn" title="Tukar Keterlihatan"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg></button>
                         <button id="move-layer-up-btn" class="icon-btn" title="Naikkan Lapisan"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="18 15 12 9 6 15"/></svg></button>
                         <button id="move-layer-down-btn" class="icon-btn" title="Turunkan Lapisan"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg></button>
                    </div>
                </div>
            </div>
        </header>

        <main id="canvas-area">
            <div id="canvas-container">
                <div id="canvas-wrapper">
                    <canvas id="preview-canvas"></canvas>
                </div>
            </div>
             <div id="custom-cursor"></div>
             <div id="image-transform-overlay">
                <div id="transform-image-wrapper">
                    <img id="transform-image" src="" alt="Image for transformation">
                    <div class="resize-handle top-left"></div>
                    <div class="resize-handle top-right"></div>
                    <div class="resize-handle bottom-left"></div>
                    <div class="resize-handle bottom-right"></div>
                </div>
                <div id="image-transform-controls">
                    <button id="cancel-transform-btn" class="transform-btn cancel">Batal</button>
                    <button id="confirm-transform-btn" class="transform-btn">Sahkan Kedudukan</button>
                </div>
            </div>
        </main>
        
        <footer id="color-palette-container">
            <label for="theme-selector">Tema:</label>
            <select id="theme-selector">
                <option value="asas">Asas</option>
                <option value="pastel">Pastel</option>
                <option value="neon">Neon</option>
                <option value="alam">Alam</option>
            </select>
            <div id="theme-swatches"></div>
        </footer>
    </div>
    
    <div id="startup-dialog-overlay" class="dialog-overlay">
        <div class="dialog-box">
            <h2 class="dialog-message">Selamat Datang ke Lukisan Kreatif!</h2>
            <div id="new-project-options">
                <button id="create-new-btn" class="dialog-btn startup-btn">Cipta Projek Baru</button>
                <button id="load-existing-btn" class="dialog-btn startup-btn">Buka Projek (.jan)</button>
            </div>
        </div>
    </div>
    <div id="new-project-dialog-overlay" class="dialog-overlay" style="display: none;">
        <div class="dialog-box">
            <h2 class="dialog-message">Pilih Latar Belakang</h2>
            <div id="new-project-options">
                <button id="create-white-bg-btn" class="dialog-btn startup-btn">Putih</button>
                <button id="create-trans-bg-btn" class="dialog-btn startup-btn">Lutsinar</button>
            </div>
        </div>
    </div>
    <div id="confirm-dialog-overlay" class="dialog-overlay" style="display: none;">
        <div class="dialog-box">
            <p id="confirm-message" class="dialog-message"></p>
            <div>
                <button id="confirm-yes" class="dialog-btn">Ya</button>
                <button id="confirm-no" class="dialog-btn">Tidak</button>
            </div>
        </div>
    </div>
    <div id="prompt-dialog-overlay" class="dialog-overlay" style="display: none;">
        <div class="dialog-box">
            <p id="prompt-message" class="dialog-message"></p>
            <input type="text" id="prompt-input">
            <div>
                <button id="prompt-save" class="dialog-btn">Simpan</button>
                <button id="prompt-cancel" class="dialog-btn">Batal</button>
            </div>
        </div>
    </div>
    <input type="file" id="bg-image-input" accept="image/*" style="display: none;">
    <input type="file" id="project-input" accept=".jan" style="display: none;">

    <script>
        // --- Full Integrated JavaScript ---
        class CustomPrompt {
            constructor() { this.overlay = document.getElementById('prompt-dialog-overlay'); this.messageEl = document.getElementById('prompt-message'); this.inputEl = document.getElementById('prompt-input'); this.saveBtn = document.getElementById('prompt-save'); this.cancelBtn = document.getElementById('prompt-cancel'); }
            show(message, defaultValue = '') { return new Promise((resolve) => { this.messageEl.textContent = message; this.inputEl.value = defaultValue; this.overlay.style.display = 'flex'; this.inputEl.focus(); this.inputEl.select(); const saveHandler = () => { this.overlay.style.display = 'none'; cleanup(); resolve(this.inputEl.value.trim()); }; const cancelHandler = () => { this.overlay.style.display = 'none'; cleanup(); resolve(null); }; const keydownHandler = (e) => { if (e.key === 'Enter') { saveHandler(); } else if (e.key === 'Escape') { cancelHandler(); } }; const cleanup = () => { this.saveBtn.removeEventListener('click', saveHandler); this.cancelBtn.removeEventListener('click', cancelHandler); document.removeEventListener('keydown', keydownHandler); }; this.saveBtn.addEventListener('click', saveHandler); this.cancelBtn.addEventListener('click', cancelHandler); document.addEventListener('keydown', keydownHandler); }); }
        }
        class CustomConfirm {
            constructor() { this.overlay = document.getElementById('confirm-dialog-overlay'); this.messageEl = document.getElementById('confirm-message'); this.yesBtn = document.getElementById('confirm-yes'); this.noBtn = document.getElementById('confirm-no'); } show(message) { return new Promise((resolve) => { this.messageEl.textContent = message; this.overlay.style.display = 'flex'; const yesHandler = () => { this.overlay.style.display = 'none'; resolve(true); this.yesBtn.removeEventListener('click', yesHandler); this.noBtn.removeEventListener('click', noHandler); }; const noHandler = () => { this.overlay.style.display = 'none'; resolve(false); this.yesBtn.removeEventListener('click', yesHandler); this.noBtn.removeEventListener('click', noHandler); }; this.yesBtn.addEventListener('click', yesHandler); this.noBtn.addEventListener('click', noHandler); }); }
        }
        
        class DrawingApp {
            constructor() {
                this.setupDOMReferences();
                this.initializeAppState();
                window.addEventListener('load', () => this.initApp());
            }
             initApp() {
                this.setupEventListeners();
                this.showStartupDialog();
            }

            setupDOMReferences() {
                this.appContainer = document.getElementById('app-container'); this.toolbarContainer = document.getElementById('toolbar-container'); this.canvasArea = document.getElementById('canvas-area'); this.canvasContainer = document.getElementById('canvas-container'); this.canvasWrapper = document.getElementById('canvas-wrapper'); this.previewCanvas = document.getElementById('preview-canvas'); this.previewCtx = this.previewCanvas.getContext('2d'); this.customCursor = document.getElementById('custom-cursor'); this.confirmDialog = new CustomConfirm(); this.promptDialog = new CustomPrompt(); this.primaryButtons = document.querySelectorAll('.primary-tool-btn:not(#toggle-secondary-toolbar)'); this.secondaryToolbars = document.querySelectorAll('.secondary-toolbar'); this.toggleSecondaryBtn = document.getElementById('toggle-secondary-toolbar'); this.toolButtons = document.querySelectorAll('.icon-btn[data-tool]'); this.sizeSlider = document.getElementById('size-slider'); this.sizeDisplay = document.getElementById('size-display'); this.opacitySlider = document.getElementById('opacity-slider'); this.opacityDisplay = document.getElementById('opacity-display'); this.colorPicker = document.getElementById('color-picker'); this.prevColor1 = document.getElementById('prev-color-1'); this.prevColor2 = document.getElementById('prev-color-2'); this.brushTypeSelect = document.getElementById('brush-type-select'); this.layersDropdown = document.getElementById('layers-dropdown'); this.addLayerBtn = document.getElementById('add-layer-btn'); this.deleteLayerBtn = document.getElementById('delete-layer-btn'); this.visibilityBtn = document.getElementById('visibility-btn'); this.moveLayerUpBtn = document.getElementById('move-layer-up-btn'); this.moveLayerDownBtn = document.getElementById('move-layer-down-btn'); this.bgImageInput = document.getElementById('bg-image-input'); this.projectInput = document.getElementById('project-input'); this.themeSelector = document.getElementById('theme-selector'); this.themeSwatchesContainer = document.getElementById('theme-swatches');
                this.imageTransformOverlay = document.getElementById('image-transform-overlay'); this.transformImageWrapper = document.getElementById('transform-image-wrapper'); this.transformImage = document.getElementById('transform-image');
            }

            initializeAppState() { 
                this.isDrawing = false; this.isPanning = false; this.middleClickPanning = false; 
                this.isPinching = false; this.touchActionPending = false; this.startTouchPoint = null; this.brushSize = 15; 
                this.brushColor = '#0D6EFD'; this.brushOpacity = 1; this.currentTool = 'brush'; 
                this.currentBrushType = 'round'; this.lastPoint = { x: 0, y: 0 }; 
                this.startShapePoint = {x: 0, y: 0}; this.zoom = 1; 
                this.panOffset = { x: 0, y: 0 }; this.startPanPoint = { x: 0, y: 0 }; 
                this.initialPanOffset = { x: 0, y: 0 }; this.canvasSize = { width: 1920, height: 1080 }; 
                this.layers = []; this.activeLayerIndex = -1; this.layerCounter = 0; 
                this.lastTouchDistance = null; this.lastTouchMidpoint = null;
                this.projectBackground = 'white';
                this.previousColors = ['#6C757D', '#198754'];
                this.colorThemes = { asas: ['#d90429', '#ef233c', '#edf2f4', '#8d99ae', '#2b2d42'], pastel: ['#fec5bb', '#fcd5ce', '#fae1dd', '#f8edeb', '#e8e8e4'], neon: ['#fe53bb', '#09fbd3', '#7122fa', '#fcf300', '#212529'], alam: ['#006400', '#8fbc8f', '#8b4513', '#ffdab9', '#add8e6'] };
                this.transformState = { active: false, type: null, startX: 0, startY: 0, startLeft: 0, startTop: 0, startWidth: 0, startHeight: 0 };
            }
            
            showStartupDialog() {
                document.getElementById('startup-dialog-overlay').style.display = 'flex';
                document.getElementById('create-new-btn').onclick = () => { document.getElementById('startup-dialog-overlay').style.display = 'none'; this.showNewProjectDialog(); };
                document.getElementById('load-existing-btn').onclick = () => { document.getElementById('startup-dialog-overlay').style.display = 'none'; this.projectInput.click(); };
            }

            showNewProjectDialog() {
                const dialog = document.getElementById('new-project-dialog-overlay');
                dialog.style.display = 'flex';
                document.getElementById('create-white-bg-btn').onclick = () => { dialog.style.display = 'none'; this.createNewWorkspace('white'); };
                document.getElementById('create-trans-bg-btn').onclick = () => { dialog.style.display = 'none'; this.createNewWorkspace('transparent'); };
            }

            createNewWorkspace(backgroundType) {
                this.projectBackground = backgroundType;
                if (backgroundType === 'transparent') { this.canvasWrapper.classList.add('checkerboard-bg'); this.canvasWrapper.style.backgroundColor = 'transparent'; } 
                else { this.canvasWrapper.classList.remove('checkerboard-bg'); this.canvasWrapper.style.backgroundColor = 'white'; }
                this.setupCanvasWrapperSize(); this.addLayer(); this.centerCanvas(); this.updateCursor();
                this.toolbarContainer.style.visibility = 'visible';
                window.addEventListener('resize', () => this.resizeAllCanvases());
            }
            
            setupEventListeners() {
                this.primaryButtons.forEach(button => { button.addEventListener('click', () => { this.primaryButtons.forEach(btn => btn.classList.remove('active')); button.classList.add('active'); this.showToolbar(button.dataset.target); if (this.toolbarContainer.classList.contains('secondary-hidden')) { this.toolbarContainer.classList.remove('secondary-hidden'); } }); });
                this.toggleSecondaryBtn.addEventListener('click', () => { this.toolbarContainer.classList.toggle('secondary-hidden'); });
                this.canvasArea.addEventListener('wheel', (e) => this.handleZoom(e), { passive: false });
                this.previewCanvas.addEventListener('mousedown', (e) => { if (e.button === 1) { e.preventDefault(); this.middleClickPanning = true; this.isPanning = true; const mousePos = this.getMousePosInContainer(e); this.startPanPoint = { x: mousePos.x, y: mousePos.y }; this.initialPanOffset = { x: this.panOffset.x, y: this.panOffset.y }; this.canvasContainer.classList.add('panning'); } });
                window.addEventListener('mouseup', (e) => { if (e.button === 1 && this.middleClickPanning) { e.preventDefault(); this.isPanning = false; this.middleClickPanning = false; this.canvasContainer.classList.remove('panning'); } });
                this.previewCanvas.addEventListener('mousedown', (e) => this.startAction(e)); this.previewCanvas.addEventListener('mousemove', (e) => this.moveAction(e)); this.previewCanvas.addEventListener('mouseup', (e) => this.endAction(e)); this.previewCanvas.addEventListener('mouseleave', (e) => this.endAction(e));
                this.previewCanvas.addEventListener('mouseenter', () => { if(this.currentTool !== 'pan' && !this.transformState.active) this.customCursor.style.display = 'block'; });
                this.previewCanvas.addEventListener('mouseleave', () => { this.customCursor.style.display = 'none'; });
                this.previewCanvas.addEventListener('touchstart', (e) => this.handleTouchStart(e), { passive: false }); this.previewCanvas.addEventListener('touchmove', (e) => this.handleTouchMove(e), { passive: false }); this.previewCanvas.addEventListener('touchend', (e) => this.handleTouchEnd(e));
                this.toolButtons.forEach(button => { button.addEventListener('click', () => { this.currentTool = button.dataset.tool; this.setActiveButton(button, '.icon-btn[data-tool]'); this.updateCursor(); }); });
                document.getElementById('open-project-btn').addEventListener('click', async () => { if (await this.confirmDialog.show('Membuka projek baru akan memadamkan kerja semasa anda. Teruskan?')) { this.resetWorkspace(); this.toolbarContainer.style.visibility = 'hidden'; this.showStartupDialog(); } });
                document.getElementById('save-project-btn').addEventListener('click', () => this.saveProject());
                document.getElementById('save-png-btn').addEventListener('click', () => this.saveAsPng());
                document.getElementById('open-bg-image-btn').addEventListener('click', () => this.bgImageInput.click());
                this.projectInput.addEventListener('change', (e) => this.loadProject(e)); this.bgImageInput.addEventListener('change', (e) => this.handleImageFileSelect(e));
                this.colorPicker.addEventListener('change', (e) => this.setBrushColor(e.target.value, true));
                this.prevColor1.addEventListener('click', () => { const swatchColor = this.previousColors[0]; if (!swatchColor || swatchColor.toUpperCase() === this.brushColor.toUpperCase()) return; const mainColor = this.brushColor; this.setBrushColor(swatchColor, false); this.previousColors[0] = mainColor; this.prevColor1.style.backgroundColor = mainColor; });
                this.prevColor2.addEventListener('click', () => { const swatchColor = this.previousColors[1]; if (!swatchColor || swatchColor.toUpperCase() === this.brushColor.toUpperCase()) return; const mainColor = this.brushColor; this.setBrushColor(swatchColor, false); this.previousColors[1] = mainColor; this.prevColor2.style.backgroundColor = mainColor; });
                this.themeSelector.addEventListener('change', (e) => this.updateThemeSwatches(e.target.value));
                this.themeSwatchesContainer.addEventListener('click', (e) => { if (e.target.classList.contains('theme-swatch')) { this.setBrushColor(this.rgbToHex(e.target.style.backgroundColor), true); } });
                this.brushTypeSelect.addEventListener('change', (e) => { this.currentBrushType = e.target.value; });
                this.sizeSlider.addEventListener('input', (e) => this.setBrushSize(e.target.value));
                this.opacitySlider.addEventListener('input', (e) => { this.brushOpacity = e.target.value; this.opacityDisplay.textContent = `${Math.round(e.target.value * 100)}%`; });
                this.addLayerBtn.addEventListener('click', () => this.addLayer()); this.deleteLayerBtn.addEventListener('click', () => this.deleteLayer()); this.layersDropdown.addEventListener('change', (e) => this.setActiveLayer(parseInt(e.target.value))); this.visibilityBtn.addEventListener('click', () => this.toggleVisibility()); this.moveLayerUpBtn.addEventListener('click', () => this.moveLayer('up')); this.moveLayerDownBtn.addEventListener('click', () => this.moveLayer('down'));
                document.getElementById('undo-btn').addEventListener('click', () => this.undo());
                document.getElementById('redo-btn').addEventListener('click', () => this.redo());
                
                document.querySelectorAll('.size-preset-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        this.setBrushSize(e.currentTarget.dataset.size);
                        this.setActiveButton(e.currentTarget, '.size-preset-btn');
                    });
                });

                this.showToolbar('#file-tools'); this.updateThemeSwatches('asas'); this.setActiveButton(document.getElementById('brush-btn'), '.icon-btn[data-tool]');

                document.getElementById('confirm-transform-btn').addEventListener('click', () => this.confirmImagePlacement());
                document.getElementById('cancel-transform-btn').addEventListener('click', () => this.cancelImagePlacement());
                this.imageTransformOverlay.addEventListener('mousedown', (e) => this.startTransform(e));
                window.addEventListener('mousemove', (e) => this.doTransform(e));
                window.addEventListener('mouseup', (e) => this.endTransform(e));
                this.imageTransformOverlay.addEventListener('touchstart', (e) => this.startTransform(e), { passive: false });
                this.imageTransformOverlay.addEventListener('touchmove', (e) => this.doTransform(e), { passive: false });
                this.imageTransformOverlay.addEventListener('touchend', (e) => this.endTransform(e));
            }
            
            handleTouchStart(e) {
                e.preventDefault();
                const touches = e.touches;
                if (touches.length === 1) {
                    this.touchActionPending = true;
                    this.startTouchPoint = { clientX: touches[0].clientX, clientY: touches[0].clientY };
                } else if (touches.length >= 2) {
                    this.touchActionPending = false; 
                    this.isDrawing = false;
                    this.isPinching = true;
                    this.lastTouchDistance = this.getTouchDistance(touches);
                    this.lastTouchMidpoint = this.getTouchMidpoint(touches);
                }
            }

            handleTouchMove(e) {
                e.preventDefault();
                const touches = e.touches;
                if (touches.length === 1 && !this.isPinching) {
                    if (this.touchActionPending) {
                        this.isDrawing = true;
                        this.touchActionPending = false;
                        this.startAction(this.startTouchPoint);
                    }
                    if(this.isDrawing) {
                       this.moveAction({ clientX: touches[0].clientX, clientY: touches[0].clientY });
                    }
                } else if (touches.length >= 2 && this.isPinching) {
                    const newDist = this.getTouchDistance(touches);
                    const newMidpoint = this.getTouchMidpoint(touches);
                    if (this.lastTouchDistance) { const zoomMultiplier = newDist / this.lastTouchDistance; this.zoomAtCenter(zoomMultiplier, { clientX: newMidpoint.x, clientY: newMidpoint.y }); }
                    if (this.lastTouchMidpoint) { const dx = newMidpoint.x - this.lastTouchMidpoint.x; const dy = newMidpoint.y - this.lastTouchMidpoint.y; this.panOffset.x += dx; this.panOffset.y += dy; this.updateTransform(); }
                    this.lastTouchDistance = newDist;
                    this.lastTouchMidpoint = newMidpoint;
                }
            }

            handleTouchEnd(e) {
                if (this.touchActionPending) { // This is a tap
                    this.startAction(this.startTouchPoint);
                    this.endAction(this.startTouchPoint);
                }
                if (this.isDrawing) {
                    this.endAction(e);
                }
                this.touchActionPending = false;
                this.isPinching = false;
                this.isDrawing = false;
                this.isPanning = false;
                this.lastTouchDistance = null;
                this.lastTouchMidpoint = null;
            }

            getTouchDistance(touches) { const dx = touches[0].clientX - touches[1].clientX; const dy = touches[0].clientY - touches[1].clientY; return Math.hypot(dx, dy); }
            getTouchMidpoint(touches) { const x = (touches[0].clientX + touches[1].clientX) / 2; const y = (touches[0].clientY + touches[1].clientY) / 2; return { x, y }; }
            prepareContext(ctx) {
                ctx.lineWidth = this.brushSize / this.zoom; ctx.strokeStyle = this.brushColor; ctx.fillStyle = this.brushColor; ctx.globalAlpha = this.brushOpacity;
                ctx.globalCompositeOperation = this.currentTool === 'eraser' ? 'destination-out' : 'source-over';
                ctx.lineCap = this.currentBrushType === 'square' ? 'square' : 'round';
                ctx.lineJoin = this.currentBrushType === 'square' ? 'miter' : 'round';
            }
            startAction(e) {
                if (e.button === 1 || this.transformState.active) return;
                if (this.currentTool === 'pan') {
                    this.isPanning = true; const mousePos = this.getMousePosInContainer(e);
                    this.startPanPoint = { x: mousePos.x, y: mousePos.y }; this.initialPanOffset = { x: this.panOffset.x, y: this.panOffset.y };
                    this.canvasContainer.classList.add('panning');
                } else {
                    const layer = this.getActiveLayer(); if (!layer || !layer.visible) return;
                    this.isDrawing = true; const canvasPos = this.getCanvasPosFromEvent(e);
                    if (this.currentTool === 'bucket') { this.floodFill(Math.round(canvasPos.x), Math.round(canvasPos.y)); this.saveState(); this.isDrawing = false; return; }
                    this.startShapePoint = canvasPos; this.lastPoint = canvasPos; this.prepareContext(layer.ctx);
                    if (this.currentTool === 'brush' || this.currentTool === 'eraser') {
                         const scaledBrushSize = this.brushSize / this.zoom;
                        switch (this.currentBrushType) {
                            case 'spray': this.drawSpray(layer.ctx, canvasPos); break;
                            case 'square': layer.ctx.fillRect(canvasPos.x - scaledBrushSize / 2, canvasPos.y - scaledBrushSize / 2, scaledBrushSize, scaledBrushSize); break;
                            case 'round': layer.ctx.beginPath(); layer.ctx.arc(canvasPos.x, canvasPos.y, scaledBrushSize / 2, 0, 2 * Math.PI); layer.ctx.fill(); break;
                        }
                        layer.ctx.beginPath(); layer.ctx.moveTo(canvasPos.x, canvasPos.y);
                    }
                }
            }
            moveAction(e) {
                const mousePosContainer = this.getMousePosInContainer(e); this.updateCursorPosition(mousePosContainer);
                if (this.isPanning) {
                    const dx = mousePosContainer.x - this.startPanPoint.x; const dy = mousePosContainer.y - this.startPanPoint.y;
                    this.panOffset.x = this.initialPanOffset.x + dx; this.panOffset.y = this.initialPanOffset.y + dy;
                    this.updateTransform();
                } else if (this.isDrawing) {
                    const canvasPos = this.getCanvasPosFromEvent(e); const layer = this.getActiveLayer(); if (!layer) return;
                    if (this.currentTool === 'brush' || this.currentTool === 'eraser') {
                        switch (this.currentBrushType) {
                            case 'round': case 'square':
                                layer.ctx.lineTo(canvasPos.x, canvasPos.y); layer.ctx.stroke();
                                layer.ctx.beginPath(); layer.ctx.moveTo(canvasPos.x, canvasPos.y); break;
                            case 'spray': this.drawSpray(layer.ctx, canvasPos); break;
                        }
                    } else {
                        this.previewCtx.clearRect(0, 0, this.previewCanvas.width, this.previewCanvas.height);
                        this.prepareContext(this.previewCtx);
                        this.drawShape(this.previewCtx, this.startShapePoint, canvasPos, this.currentTool);
                    }
                }
            }
            endAction(e) {
                if (e.button === 1) return;
                if (this.isDrawing) {
                    const layer = this.getActiveLayer();
                    if (layer) {
                        const canvasPos = this.getCanvasPosFromEvent(e); 
                        if (['line', 'rectangle', 'circle'].includes(this.currentTool)) {
                            this.previewCtx.clearRect(0, 0, this.previewCanvas.width, this.previewCanvas.height);
                            this.prepareContext(layer.ctx);
                            this.drawShape(layer.ctx, this.startShapePoint, canvasPos, this.currentTool);
                        }
                        layer.ctx.closePath(); this.saveState();
                    }
                }
                this.isDrawing = false; this.isPanning = false; this.canvasContainer.classList.remove('panning');
            }
            floodFill(startX, startY) { const layer = this.getActiveLayer(); if (!layer) return; const ctx = layer.ctx; const canvasWidth = layer.canvas.width; const canvasHeight = layer.canvas.height; const imageData = ctx.getImageData(0, 0, canvasWidth, canvasHeight); const data = imageData.data; const getPixelIndex = (x, y) => (y * canvasWidth + x) * 4; const targetColorIndex = getPixelIndex(startX, startY); const targetColor = [ data[targetColorIndex], data[targetColorIndex + 1], data[targetColorIndex + 2], data[targetColorIndex + 3] ]; const hexToRgba = (hex) => { const r = parseInt(hex.slice(1, 3), 16); const g = parseInt(hex.slice(3, 5), 16); const b = parseInt(hex.slice(5, 7), 16); return [r, g, b, Math.round(this.brushOpacity * 255)]; }; const fillColor = hexToRgba(this.brushColor); if (targetColor.every((v, i) => v === fillColor[i])) return; const pixelsToCheck = [startX, startY]; while (pixelsToCheck.length > 0) { const y = pixelsToCheck.pop(); const x = pixelsToCheck.pop(); const currentIndex = getPixelIndex(x, y); if (x < 0 || x >= canvasWidth || y < 0 || y >= canvasHeight) continue; if (data[currentIndex] === targetColor[0] && data[currentIndex + 1] === targetColor[1] && data[currentIndex + 2] === targetColor[2] && data[currentIndex + 3] === targetColor[3]) { data[currentIndex] = fillColor[0]; data[currentIndex + 1] = fillColor[1]; data[currentIndex + 2] = fillColor[2]; data[currentIndex + 3] = fillColor[3]; pixelsToCheck.push(x + 1, y); pixelsToCheck.push(x - 1, y); pixelsToCheck.push(x, y + 1); pixelsToCheck.push(x, y - 1); } } ctx.putImageData(imageData, 0, 0); }
            addLayer(data = null) { this.layerCounter++; const canvas = document.createElement('canvas'); canvas.className = 'canvas-layer'; canvas.width = this.canvasSize.width; canvas.height = this.canvasSize.height; const ctx = canvas.getContext('2d'); this.canvasWrapper.insertBefore(canvas, this.previewCanvas); const layer = { id: this.layerCounter, name: data ? data.name : `Lapisan ${this.layerCounter}`, canvas: canvas, ctx: ctx, history: [], historyIndex: -1, visible: data ? data.visible : true }; this.layers.push(layer); this.setActiveLayer(layer.id); if (data && data.imageDataURL) { const img = new Image(); img.onload = () => { layer.ctx.drawImage(img, 0, 0); this.saveState(); }; img.src = data.imageDataURL; } else { this.saveState(); } if (data && !data.visible) { layer.canvas.style.display = 'none'; } this.renderLayersList(); return layer; }
            async deleteLayer() { if (this.layers.length <= 1) return; const confirmed = await this.confirmDialog.show('Anda pasti mahu memadam lapisan ini?'); if (confirmed) { const layerToRemoveIndex = this.layers.findIndex(l => l.id === this.activeLayerIndex); if(layerToRemoveIndex === -1) return; this.layers[layerToRemoveIndex].canvas.remove(); this.layers.splice(layerToRemoveIndex, 1); this.setActiveLayer(this.layers.length > 0 ? this.layers[this.layers.length - 1].id : -1); } }
            setActiveLayer(id) { this.activeLayerIndex = id; this.renderLayersList(); this.updateHistoryButtons(); }
            toggleVisibility() { const layer = this.getActiveLayer(); if (!layer) return; layer.visible = !layer.visible; layer.canvas.style.display = layer.visible ? 'block' : 'none'; this.renderLayersList(); }
            moveLayer(direction) { const currentIndex = this.layers.findIndex(l => l.id === this.activeLayerIndex); if (currentIndex === -1) return; if (direction === 'up' && currentIndex < this.layers.length - 1) { [this.layers[currentIndex], this.layers[currentIndex + 1]] = [this.layers[currentIndex + 1], this.layers[currentIndex]]; } else if (direction === 'down' && currentIndex > 0) { [this.layers[currentIndex], this.layers[currentIndex - 1]] = [this.layers[currentIndex - 1], this.layers[currentIndex]]; } this.renderCanvasOrder(); this.renderLayersList(); }
            renderCanvasOrder() { const allCanvases = [...this.canvasWrapper.querySelectorAll('.canvas-layer')]; allCanvases.forEach(c => c.remove()); this.layers.forEach(layer => { this.canvasWrapper.insertBefore(layer.canvas, this.previewCanvas); }); }
            renderLayersList() { this.layersDropdown.innerHTML = ''; [...this.layers].reverse().forEach(layer => { const option = document.createElement('option'); option.value = layer.id; option.textContent = layer.name; if (!layer.visible) { option.classList.add('hidden-layer'); } this.layersDropdown.appendChild(option); }); this.layersDropdown.value = this.activeLayerIndex; const activeLayer = this.getActiveLayer(); const currentIndex = this.layers.findIndex(l => l.id === this.activeLayerIndex); if (activeLayer) { this.visibilityBtn.innerHTML = activeLayer.visible ? '👁️' : '➖'; this.deleteLayerBtn.disabled = this.layers.length <= 1; this.moveLayerUpBtn.disabled = currentIndex >= this.layers.length - 1; this.moveLayerDownBtn.disabled = currentIndex <= 0; } }
            getActiveLayer() { return this.layers.find(l => l.id === this.activeLayerIndex); }
            setupCanvasWrapperSize() { this.canvasWrapper.style.width = `${this.canvasSize.width}px`; this.canvasWrapper.style.height = `${this.canvasSize.height}px`; this.previewCanvas.width = this.canvasSize.width; this.previewCanvas.height = this.canvasSize.height; }
            resizeAllCanvases() { this.centerCanvas(); }
            drawSpray(ctx, pos) { const density = this.brushSize * 0.5; for (let i = 0; i < density; i++) { const angle = Math.random() * 2 * Math.PI; const radius = Math.random() * (this.brushSize / 2 / this.zoom); const offsetX = Math.cos(angle) * radius; const offsetY = Math.sin(angle) * radius; ctx.fillRect(pos.x + offsetX, pos.y + offsetY, 1, 1); } }
            drawShape(ctx, start, end, tool) { ctx.beginPath(); switch(tool) { case 'line': ctx.moveTo(start.x, start.y); ctx.lineTo(end.x, end.y); break; case 'rectangle': ctx.rect(start.x, start.y, end.x - start.x, end.y - start.y); break; case 'circle': const dx = end.x - start.x; const dy = end.y - start.y; const radius = Math.sqrt(dx * dx + dy * dy); ctx.arc(start.x, start.y, radius, 0, 2 * Math.PI); break; } ctx.stroke(); }
            saveState() { const layer = this.getActiveLayer(); if (!layer) return; layer.history = layer.history.slice(0, layer.historyIndex + 1); layer.history.push(layer.ctx.getImageData(0, 0, this.canvasSize.width, this.canvasSize.height)); layer.historyIndex++; this.updateHistoryButtons(); }
            handleZoom(e) { e.preventDefault(); const zoomIntensity = 0.1; const wheel = e.deltaY < 0 ? 1 : -1; const zoomMultiplier = Math.exp(wheel * zoomIntensity); this.zoomAtCenter(zoomMultiplier, e); }
            centerCanvas() { const cRect = this.canvasContainer.getBoundingClientRect(); this.zoom = Math.min(cRect.width / this.canvasSize.width, cRect.height / this.canvasSize.height) * 0.9; this.panOffset.x = (cRect.width - this.canvasSize.width * this.zoom) / 2; this.panOffset.y = (cRect.height - this.canvasSize.height * this.zoom) / 2; this.updateTransform(); }
            updateTransform() { this.canvasWrapper.style.transform = `translate(${this.panOffset.x}px, ${this.panOffset.y}px) scale(${this.zoom})`; const cursorSize = this.brushSize; this.customCursor.style.width = `${cursorSize}px`; this.customCursor.style.height = `${cursorSize}px`; }
            updateCursorPosition(pos) { this.customCursor.style.left = `${pos.x}px`; this.customCursor.style.top = `${pos.y}px`; }
            getEventCoordinates(e) { if (e.touches && e.touches.length > 0) { return { clientX: e.touches[0].clientX, clientY: e.touches[0].clientY }; } if (e.changedTouches && e.changedTouches.length > 0) { return { clientX: e.changedTouches[0].clientX, clientY: e.changedTouches[0].clientY }; } return { clientX: e.clientX, clientY: e.clientY }; }
            getCanvasPosFromEvent(e) { const rect = this.previewCanvas.getBoundingClientRect(); const { clientX, clientY } = this.getEventCoordinates(e); return { x: (clientX - rect.left) / this.zoom, y: (clientY - rect.top) / this.zoom }; }
            getMousePosInContainer(e) { const rect = this.canvasContainer.getBoundingClientRect(); const { clientX, clientY } = this.getEventCoordinates(e); return { x: clientX - rect.left, y: clientY - rect.top }; }
            setBrushColor(color, updateHistory = true) { const upperCaseColor = color.toUpperCase(); if (!color || upperCaseColor === this.brushColor.toUpperCase()) return; const oldColor = this.brushColor; this.brushColor = upperCaseColor; this.colorPicker.value = this.brushColor; if (updateHistory) { this.updatePreviousColors(oldColor); } }
            updatePreviousColors(oldColor) { if (oldColor.toUpperCase() === this.previousColors[0].toUpperCase() || oldColor.toUpperCase() === this.previousColors[1].toUpperCase()) return; this.previousColors.unshift(oldColor); this.previousColors.pop(); this.prevColor1.style.backgroundColor = this.previousColors[0]; this.prevColor2.style.backgroundColor = this.previousColors[1]; }
            setBrushSize(size) { this.brushSize = size; this.sizeSlider.value = size; this.sizeDisplay.textContent = size; this.updateTransform(); }
            async saveAsPng() { const defaultName = `lukisan-${new Date().toISOString().slice(0,10)}`; const filename = await this.promptDialog.show("Simpan sebagai PNG:", defaultName); if (!filename) return; const tempCanvas = document.createElement('canvas'); tempCanvas.width = this.canvasSize.width; tempCanvas.height = this.canvasSize.height; const tempCtx = tempCanvas.getContext('2d'); if (this.projectBackground === 'white') { tempCtx.fillStyle = 'white'; tempCtx.fillRect(0, 0, tempCanvas.width, tempCanvas.height); } this.layers.forEach(layer => { if (layer.visible && layer.canvas) { try { tempCtx.drawImage(layer.canvas, 0, 0); } catch (error) { console.error(`Gagal melukis lapisan "${layer.name}" ke PNG:`, error); } } }); const link = document.createElement('a'); link.download = `${filename.replace(/\.png$/i, '')}.png`; link.href = tempCanvas.toDataURL('image/png'); document.body.appendChild(link); link.click(); document.body.removeChild(link); }
            async saveProject() { const defaultName = `projek-${new Date().toISOString().slice(0,10)}`; const filename = await this.promptDialog.show("Simpan sebagai Projek Jan:", defaultName); if (!filename) return; const projectData = { canvasSize: this.canvasSize, background: this.projectBackground, layers: this.layers.map(layer => ({ name: layer.name, visible: layer.visible, imageDataURL: layer.canvas.toDataURL() })) }; const jsonString = JSON.stringify(projectData); const blob = new Blob([jsonString], {type: 'application/json'}); const link = document.createElement('a'); link.href = URL.createObjectURL(blob); link.download = `${filename.replace(/\.jan$/i, '')}.jan`; link.click(); }
            async clearCanvas() { const confirmed = await this.confirmDialog.show('Anda pasti mahu mengosongkan kandungan lapisan ini?'); if (confirmed) { const layer = this.getActiveLayer(); if (layer) { layer.ctx.clearRect(0, 0, this.canvasSize.width, this.canvasSize.height); this.saveState(); } } }
            undo() { const layer = this.getActiveLayer(); if (layer && layer.historyIndex > 0) { layer.historyIndex--; layer.ctx.putImageData(layer.history[layer.historyIndex], 0, 0); this.updateHistoryButtons(); } }
            redo() { const layer = this.getActiveLayer(); if (layer && layer.historyIndex < layer.history.length - 1) { layer.historyIndex++; layer.ctx.putImageData(layer.history[layer.historyIndex], 0, 0); this.updateHistoryButtons(); } }
            updateHistoryButtons() { document.getElementById('undo-btn').disabled = !this.getActiveLayer() || this.getActiveLayer().historyIndex <= 0; document.getElementById('redo-btn').disabled = !this.getActiveLayer() || this.getActiveLayer().historyIndex >= this.getActiveLayer().history.length - 1; }
            zoomAtCenter(zoomMultiplier, event = null) { const containerRect = this.canvasContainer.getBoundingClientRect(); const center = event ? this.getMousePosInContainer(event) : { x: containerRect.width / 2, y: containerRect.height / 2 }; this.panOffset.x = center.x - (center.x - this.panOffset.x) * zoomMultiplier; this.panOffset.y = center.y - (center.y - this.panOffset.y) * zoomMultiplier; this.zoom *= zoomMultiplier; this.updateTransform(); }
            updateCursor() { if (this.currentTool === 'pan' || this.middleClickPanning) { this.canvasContainer.style.cursor = 'grab'; this.customCursor.style.display = 'none'; } else { this.canvasContainer.style.cursor = 'none'; } this.updateTransform(); }
            setActiveButton(button, selector) { this.toolbarContainer.querySelectorAll(selector).forEach(btn => btn.classList.remove('active')); if(button) button.classList.add('active'); }
            async handleImageFileSelect(event) { const file = event.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (e) => { this.transformImage.src = e.target.result; this.transformImage.onload = () => { const containerRect = this.canvasArea.getBoundingClientRect(); const imgAspectRatio = this.transformImage.naturalWidth / this.transformImage.naturalHeight; let initialWidth = containerRect.width * 0.5; let initialHeight = initialWidth / imgAspectRatio; if (initialHeight > containerRect.height * 0.5) { initialHeight = containerRect.height * 0.5; initialWidth = initialHeight * imgAspectRatio; } this.transformImageWrapper.style.width = `${initialWidth}px`; this.transformImageWrapper.style.height = `${initialHeight}px`; this.transformImageWrapper.style.left = `${(containerRect.width - initialWidth) / 2}px`; this.transformImageWrapper.style.top = `${(containerRect.height - initialHeight) / 2}px`; this.imageTransformOverlay.style.display = 'block'; } }; reader.readAsDataURL(file); this.bgImageInput.value = ''; }
            startTransform(e) {
                e.preventDefault();
                const eventCoord = this.getEventCoordinates(e);
                this.transformState.active = true;
                this.transformState.startX = eventCoord.clientX;
                this.transformState.startY = eventCoord.clientY;
                const wrapperRect = this.transformImageWrapper.getBoundingClientRect();
                const containerRect = this.canvasArea.getBoundingClientRect(); this.transformState.startLeft = wrapperRect.left - containerRect.left; this.transformState.startTop = wrapperRect.top - containerRect.top; this.transformState.startWidth = wrapperRect.width; this.transformState.startHeight = wrapperRect.height;
                if (e.target && e.target.classList.contains('resize-handle')) { this.transformState.type = 'resize'; this.transformState.handle = e.target.className.replace('resize-handle ', ''); }
                else if (e.touches && e.touches.length === 2) { this.transformState.type = 'pinch'; this.transformState.startPinchDist = this.getTouchDistance(e.touches); }
                else { this.transformState.type = 'move'; }
            }
            doTransform(e) {
                if (!this.transformState.active) return;
                e.preventDefault();
                const eventCoord = this.getEventCoordinates(e);
                const dx = eventCoord.clientX - this.transformState.startX;
                const dy = eventCoord.clientY - this.transformState.startY;

                if (this.transformState.type === 'move') { this.transformImageWrapper.style.left = `${this.transformState.startLeft + dx}px`; this.transformImageWrapper.style.top = `${this.transformState.startTop + dy}px`; }
                else if (this.transformState.type === 'resize') { let newWidth = this.transformState.startWidth; let newHeight = this.transformState.startHeight; const aspectRatio = this.transformState.startWidth / this.transformState.startHeight; switch (this.transformState.handle) { case 'bottom-right': newWidth = this.transformState.startWidth + dx; newHeight = newWidth / aspectRatio; break; case 'bottom-left': newWidth = this.transformState.startWidth - dx; newHeight = newWidth / aspectRatio; this.transformImageWrapper.style.left = `${this.transformState.startLeft + dx}px`; break; case 'top-right': newWidth = this.transformState.startWidth + dx; newHeight = newWidth / aspectRatio; this.transformImageWrapper.style.top = `${this.transformState.startTop + dy}px`; break; case 'top-left': newWidth = this.transformState.startWidth - dx; newHeight = newWidth / aspectRatio; this.transformImageWrapper.style.left = `${this.transformState.startLeft + dx}px`; this.transformImageWrapper.style.top = `${this.transformState.startTop + dy}px`; break; } this.transformImageWrapper.style.width = `${Math.max(20, newWidth)}px`; this.transformImageWrapper.style.height = `${Math.max(20, newHeight)}px`; }
                else if (this.transformState.type === 'pinch' && e.touches && e.touches.length === 2) {
                    const newDist = this.getTouchDistance(e.touches);
                    const scale = newDist / this.transformState.startPinchDist;
                    const newWidth = this.transformState.startWidth * scale;
                    const newHeight = this.transformState.startHeight * scale;
                    
                    const midPoint = this.getTouchMidpoint(e.touches);
                    const containerRect = this.canvasArea.getBoundingClientRect();
                    const midX = midPoint.x - containerRect.left;
                    const midY = midPoint.y - containerRect.top;

                    const newLeft = midX - (midX - this.transformState.startLeft) * scale;
                    const newTop = midY - (midY - this.transformState.startTop) * scale;

                    this.transformImageWrapper.style.width = `${Math.max(20, newWidth)}px`;
                    this.transformImageWrapper.style.height = `${Math.max(20, newHeight)}px`;
                    this.transformImageWrapper.style.left = `${newLeft}px`;
                    this.transformImageWrapper.style.top = `${newTop}px`;
                }
            }
            endTransform(e) { this.transformState.active = false; this.transformState.type = null; }
            confirmImagePlacement() { const baseLayer = this.layers[0]; if (!baseLayer) { this.cancelImagePlacement(); return; } const wrapperRect = this.transformImageWrapper.getBoundingClientRect(); const canvasRect = this.previewCanvas.getBoundingClientRect(); const destX = (wrapperRect.left - canvasRect.left) / this.zoom; const destY = (wrapperRect.top - canvasRect.top) / this.zoom; const destWidth = wrapperRect.width / this.zoom; const destHeight = wrapperRect.height / this.zoom; baseLayer.ctx.drawImage(this.transformImage, destX, destY, destWidth, destHeight); const originalActiveLayerId = this.activeLayerIndex; this.setActiveLayer(baseLayer.id); this.saveState(); this.setActiveLayer(originalActiveLayerId); this.cancelImagePlacement(); }
            cancelImagePlacement() { this.imageTransformOverlay.style.display = 'none'; this.transformImage.src = ''; this.endTransform(); }
            async loadProject(event) { const file = (event && event.target) ? event.target.files[0] : null; if (!file) { this.showStartupDialog(); return; } const reader = new FileReader(); reader.onload = (e) => { try { const projectData = JSON.parse(e.target.result); this.resetWorkspace(); this.createNewWorkspace(projectData.background || 'white'); this.layers[0].canvas.remove(); this.layers = []; this.layerCounter = 0; this.canvasSize = projectData.canvasSize; this.setupCanvasWrapperSize(); projectData.layers.forEach(layerData => this.addLayer(layerData)); this.resetUIToDefaults(); } catch (err) { alert('Gagal membuka fail projek. Fail mungkin rosak.'); console.error("Error parsing project file:", err); this.showStartupDialog(); } }; reader.readAsText(file); if (this.projectInput) this.projectInput.value = ''; }
            resetWorkspace() { this.layers.forEach(layer => layer.canvas.remove()); this.initializeAppState(); this.resetUIToDefaults(); this.canvasWrapper.classList.remove('checkerboard-bg'); this.canvasWrapper.style.backgroundColor = 'white'; }
            resetUIToDefaults() {
                this.setBrushColor('#0D6EFD', false); this.colorPicker.value = '#0D6EFD';
                this.setBrushSize(15);
                this.opacitySlider.value = 1; this.opacityDisplay.textContent = '100%'; this.brushOpacity = 1;
                this.previousColors = ['#6C757D', '#198754']; this.prevColor1.style.backgroundColor = this.previousColors[0]; this.prevColor2.style.backgroundColor = this.previousColors[1];
                this.currentTool = 'brush'; this.setActiveButton(document.getElementById('brush-btn'), '.icon-btn[data-tool]');
                this.brushTypeSelect.value = 'round'; this.currentBrushType = 'round';
                this.setActiveButton(document.querySelector('.size-preset-btn[data-size="15"]'), '.size-preset-btn');
            }
            showToolbar(targetId) { this.secondaryToolbars.forEach(bar => { bar.style.display = 'none'; }); const targetToolbar = document.querySelector(targetId); if (targetToolbar) { targetToolbar.style.display = 'flex'; } }
            updateThemeSwatches(themeName) { const palette = this.colorThemes[themeName] || []; this.themeSwatchesContainer.innerHTML = ''; palette.forEach(color => { const swatch = document.createElement('div'); swatch.className = 'color-swatch theme-swatch'; swatch.style.backgroundColor = color; swatch.title = color; this.themeSwatchesContainer.appendChild(swatch); }); }
            rgbToHex(rgb) { if (!rgb || !rgb.startsWith('rgb')) return rgb; let [r, g, b] = rgb.match(/\d+/g).map(Number); return "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1).toUpperCase(); }
        }
        
        new DrawingApp();
    </script>
</body>
</html>

